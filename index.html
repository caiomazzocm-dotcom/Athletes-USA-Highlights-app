<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AUSA Highlights</title>
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="AUSA Highlights" />
<meta name="theme-color" content="#11111b" />
<link rel="apple-touch-icon" href="apple-touch-icon.png" />
<link rel="manifest" href="manifest.json" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  html,body,#root{width:100%;height:100%;overflow-x:hidden;overflow-y:hidden}
  html,body{max-width:100vw}
  ::-webkit-scrollbar{width:8px;height:8px}
  ::-webkit-scrollbar-track{background:#11111b}
  ::-webkit-scrollbar-thumb{background:#45475a;border-radius:4px}
  ::-webkit-scrollbar-thumb:hover{background:#585b70}
  input[type="range"]{height:4px;appearance:none;background:#313244;border-radius:2px;outline:none}
  input[type="range"]::-webkit-slider-thumb{appearance:none;width:12px;height:12px;border-radius:50%;cursor:pointer;background:#89b4fa}
  @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
  .drag-over-cat{outline:2px solid #3b82f6!important;outline-offset:-2px}

  /* ═══ MOBILE RESPONSIVE (athlete-facing pages only) ═══ */
  @media(max-width:640px){
    .ath-header{padding:12px 16px 0!important}
    .ath-header-row{flex-wrap:wrap!important;gap:8px!important}
    .ath-header-row .ath-brand{display:none!important}
    .ath-header-row .ath-brand-sep{display:none!important}
    .ath-header-info{font-size:15px!important}
    .ath-signout{padding:6px 12px!important;font-size:11px!important}
    .ath-zip-btn{padding:6px 10px!important;font-size:10px!important}
    .ath-photos-row{flex-wrap:wrap!important}
    .ath-desc{font-size:11px!important}
    .ath-cats-scroll{padding:16px!important;overflow-x:auto!important;overflow-y:auto!important}
    .ath-cats-flex{flex-direction:column!important;height:auto!important;overflow:visible!important}
    .ath-cat-card{min-width:100%!important;width:100%!important;max-height:320px!important}
    .ath-select-grid{grid-template-columns:1fr 1fr!important;gap:12px!important}
    .ath-select-wrap{padding:16px!important}
    .ath-form-wrap{padding:16px!important}
    .ath-form-3col{grid-template-columns:1fr!important;gap:10px!important}
    .ath-form-2col{grid-template-columns:1fr!important;gap:12px!important}
    .ath-form-picbox{height:120px!important}
    .ath-select-header{padding:0 12px!important}
    .ath-newcat-card{min-width:100%!important;width:100%!important}
  }
  @media(max-width:380px){
    .ath-select-grid{grid-template-columns:1fr!important}
  }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const{useState,useRef,useEffect,useCallback}=React;

/* ═══ ICONS ═══ */
const I=({d,size=16,color="currentColor",...p})=><svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}>{d}</svg>;
const PlayIcon=p=><I {...p} d={<polygon points="5 3 19 12 5 21 5 3" fill="currentColor" stroke="none"/>}/>;
const PauseIcon=p=><I {...p} d={<><rect x="6" y="4" width="4" height="16" fill="currentColor" stroke="none"/><rect x="14" y="4" width="4" height="16" fill="currentColor" stroke="none"/></>}/>;
const SkipBackIcon=p=><I {...p} d={<><polygon points="19 20 9 12 19 4 19 20"/><line x1="5" y1="19" x2="5" y2="5"/></>}/>;
const ScissorsIcon=p=><I {...p} d={<><circle cx="6" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><line x1="20" y1="4" x2="8.12" y2="15.88"/><line x1="14.47" y1="14.48" x2="20" y2="20"/><line x1="8.12" y1="8.12" x2="12" y2="12"/></>}/>;
const MousePointerIcon=p=><I {...p} d={<><path d="m3 3 7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/><path d="m13 13 6 6"/></>}/>;
const Trash2Icon=p=><I {...p} d={<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></>}/>;
const Undo2Icon=p=><I {...p} d={<><path d="M9 14 4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></>}/>;
const ZoomInIcon=p=><I {...p} d={<><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></>}/>;
const ZoomOutIcon=p=><I {...p} d={<><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></>}/>;
const Volume2Icon=p=><I {...p} d={<><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></>}/>;
const UploadIcon=p=><I {...p} d={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></>}/>;
const PlusIcon=p=><I {...p} d={<><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>}/>;
const Edit3Icon=p=><I {...p} d={<><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></>}/>;
const FilmIcon=p=><I {...p} d={<><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"/><line x1="7" y1="2" x2="7" y2="22"/><line x1="17" y1="2" x2="17" y2="22"/><line x1="2" y1="12" x2="22" y2="12"/></>}/>;
const ChevronRightIcon=p=><I {...p} d={<polyline points="9 18 15 12 9 6"/>}/>;
const ChevronDownIcon=p=><I {...p} d={<polyline points="6 9 12 15 18 9"/>}/>;
const XIcon=p=><I {...p} d={<><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>}/>;
const CheckIcon=p=><I {...p} d={<polyline points="20 6 9 17 4 12"/>}/>;
const ArrowLeftIcon=p=><I {...p} d={<><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></>}/>;
const LockIcon=p=><I {...p} d={<><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>}/>;
const UserIcon=p=><I {...p} d={<><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>}/>;
const ClapperIcon=p=><I {...p} d={<><path d="M4 11v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><path d="M4 11l3-7h10l3 7"/><line x1="8" y1="11" x2="10" y2="4"/><line x1="14" y1="11" x2="16" y2="4"/></>}/>;
const LogOutIcon=p=><I {...p} d={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></>}/>;
const EyeIcon=p=><I {...p} d={<><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></>}/>;
const EyeOffIcon=p=><I {...p} d={<><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/><path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/><line x1="1" y1="1" x2="23" y2="23"/></>}/>;
const FolderIcon=p=><I {...p} d={<><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></>}/>;
const FolderOpenIcon=p=><I {...p} d={<><path d="m6 14 1.5-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.54 6a2 2 0 0 1-1.95 1.5H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H18a2 2 0 0 1 2 2v2"/></>}/>;
const UsersIcon=p=><I {...p} d={<><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>}/>;
const MusicIcon=p=><I {...p} d={<><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></>}/>;
const GripIcon=p=><I {...p} d={<><circle cx="9" cy="5" r="1" fill="currentColor" stroke="none"/><circle cx="15" cy="5" r="1" fill="currentColor" stroke="none"/><circle cx="9" cy="12" r="1" fill="currentColor" stroke="none"/><circle cx="15" cy="12" r="1" fill="currentColor" stroke="none"/><circle cx="9" cy="19" r="1" fill="currentColor" stroke="none"/><circle cx="15" cy="19" r="1" fill="currentColor" stroke="none"/></>}/>;
const MaximizeIcon=p=><I {...p} d={<><path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M21 8V5a2 2 0 0 0-2-2h-3"/><path d="M3 16v3a2 2 0 0 0 2 2h3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/></>}/>;
const DownloadIcon=p=><I {...p} d={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></>}/>;
const RefreshIcon=p=><I {...p} d={<><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></>}/>;
const MagnetIcon=p=><I {...p} d={<><path d="M6 15V9a6 6 0 0 1 12 0v6"/><path d="M6 15a2 2 0 0 1-2-2v-2a2 2 0 0 1 2-2"/><path d="M18 15a2 2 0 0 0 2-2v-2a2 2 0 0 0-2-2"/><line x1="6" y1="11" x2="6" y2="15"/><line x1="18" y1="11" x2="18" y2="15"/></>}/>;
const FitIcon=p=><I {...p} d={<><path d="M15 3h6v6"/><path d="M9 21H3v-6"/><path d="M21 3l-7 7"/><path d="M3 21l7-7"/></>}/>;
const MessageSquareIcon=p=><I {...p} d={<><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></>}/>;

/* ═══ CONSTANTS ═══ */
const CAT_COLORS=["#a6e3a1","#89b4fa","#f5c2e7","#f9e2af","#cba6f7","#fab387","#94e2d5","#f38ba8","#a6adc8","#74c7ec"];
const PLAYER_COLORS=["#3b82f6","#8b5cf6","#06b6d4","#f59e0b","#10b981","#ef4444","#ec4899","#6366f1"];
const C={base:"#0a0a14",mantle:"#0f0f1a",crust:"#080810",s0:"#1a1a2e",s1:"#2a2a40",s2:"#3a3a55",
  text:"#e2e8f0",sub:"#94a3b8",overlay:"#64748b",blue:"#3b82f6",red:"#ef4444",green:"#22c55e",
  yellow:"#eab308",lavender:"#a78bfa",peach:"#fb923c",coral:"#f43f5e"};
const STUDIO_PASSWORD="admin";
const DEFAULT_CATS=["Full Highlights","Goals","Assists","Defensive Actions","Attacking Actions"];
let _id=0;const uid=(p="id")=>`${p}-${++_id}-${Date.now().toString(36)}`;
const fmtTime=s=>{if(!isFinite(s)||s<0)s=0;const m=Math.floor(s/60),sec=Math.floor(s%60),fr=Math.floor((s%1)*30);return`${String(m).padStart(2,"0")}:${String(sec).padStart(2,"0")}:${String(fr).padStart(2,"0")}`};
const TRACK_H=74,AUDIO_TRACK_H=48,TAG_TRACK_H=36,RULER_H=28,MIN_CLIP_W=4;
const YT_W=1920,YT_H=1080;
const ib={background:"none",border:"none",cursor:"pointer",padding:4,display:"flex",alignItems:"center",borderRadius:4};
const tb={display:"flex",alignItems:"center",gap:4,padding:"4px 10px",borderRadius:6,cursor:"pointer",fontWeight:500};
const inputStyle={background:C.s0,color:C.text,border:`1px solid ${C.s1}`,borderRadius:8,padding:"10px 14px",fontSize:14,outline:"none",width:"100%"};

/* ═══ HELPERS ═══ */
const getMediaDur=url=>new Promise(r=>{const v=document.createElement("video");v.preload="metadata";v.muted=true;v.addEventListener("loadedmetadata",()=>{const d=v.duration||10;v.pause();v.removeAttribute("src");v.load();r(d);});v.addEventListener("error",()=>r(10));v.src=url;});
const getAudioDur=url=>new Promise(r=>{const a=new Audio();a.preload="metadata";a.muted=true;a.addEventListener("loadedmetadata",()=>{const d=a.duration||10;a.pause();a.removeAttribute("src");a.load();r(d);});a.addEventListener("error",()=>r(10));a.src=url;});

/* ═══ INDEXED-DB VIDEO STORE ═══ */
const VDB_NAME="aua_videodb";const VDB_VER=1;const VDB_STORE="blobs";
const openVDB=()=>new Promise((res,rej)=>{const rq=indexedDB.open(VDB_NAME,VDB_VER);rq.onupgradeneeded=e=>{const db=e.target.result;if(!db.objectStoreNames.contains(VDB_STORE))db.createObjectStore(VDB_STORE);};rq.onsuccess=()=>res(rq.result);rq.onerror=()=>rej(rq.error);});
const storeBlob=async(id,blob)=>{const db=await openVDB();return new Promise((res,rej)=>{const tx=db.transaction(VDB_STORE,"readwrite");tx.objectStore(VDB_STORE).put(blob,id);tx.oncomplete=()=>res();tx.onerror=()=>rej(tx.error);});};
const getBlob=async(id)=>{const db=await openVDB();return new Promise((res,rej)=>{const tx=db.transaction(VDB_STORE,"readonly");const rq=tx.objectStore(VDB_STORE).get(id);rq.onsuccess=()=>res(rq.result||null);rq.onerror=()=>rej(rq.error);});};
const deleteBlob=async(id)=>{const db=await openVDB();return new Promise((res,rej)=>{const tx=db.transaction(VDB_STORE,"readwrite");tx.objectStore(VDB_STORE).delete(id);tx.oncomplete=()=>res();tx.onerror=()=>rej(tx.error);});};
const hydratePlayerVideos=async(players)=>{const out=[];for(const pl of players){const cats=[];for(const cat of pl.categories){const vids=[];for(const v of cat.videos){try{const blob=await getBlob(v.id);if(blob){const url=URL.createObjectURL(blob);vids.push({...v,url});}else{vids.push(v);}}catch(e){vids.push(v);}}cats.push({...cat,videos:vids});}out.push({...pl,categories:cats});}return out;};

/* ═══ FIREBASE CLOUD ═══ */
const firebaseConfig={apiKey:"AIzaSyBuce5w22HDy9mFsx5jz7g3s9XXtKUNlgE",authDomain:"athletes-usa.firebaseapp.com",projectId:"athletes-usa",storageBucket:"athletes-usa.firebasestorage.app",messagingSenderId:"599507645774",appId:"1:599507645774:web:8aa8c5f518b0dda6d45a1f"};
firebase.initializeApp(firebaseConfig);
const fbDb=firebase.firestore();
const fbStorage=firebase.storage();

const uploadVideoToCloud=async(videoId,blob,onProgress)=>{const ref=fbStorage.ref(`videos/${videoId}`);const task=ref.put(blob);if(onProgress)task.on("state_changed",snap=>onProgress(snap.bytesTransferred/snap.totalBytes));await task;return await ref.getDownloadURL();};
const deleteVideoFromCloud=async(videoId)=>{try{await fbStorage.ref(`videos/${videoId}`).delete();}catch(e){}};
const savePlayerToCloud=async(player)=>{try{const safe={id:player.id,name:player.name,recruitingClass:player.recruitingClass,size:player.size||"",dob:player.dob||"",shirtNumber:player.shirtNumber||"",uniformDesc:player.uniformDesc||"",positions:player.positions||[],profilePicUrl:player.profilePicUrl||"",playingPicUrl:player.playingPicUrl||"",categories:player.categories.map(c=>({...c,videos:c.videos.map(v=>({id:v.id,name:v.name,duration:v.duration,cloudUrl:v.cloudUrl||""}))}))};await fbDb.collection("players").doc(player.id).set(safe);}catch(e){console.warn("Cloud save failed:",e);}};
const deletePlayerFromCloud=async(playerId)=>{try{await fbDb.collection("players").doc(playerId).delete();}catch(e){}};
const loadPlayersFromCloud=async()=>{try{const snap=await fbDb.collection("players").get();return snap.docs.map(d=>{const p=d.data();return{...p,categories:(p.categories||[]).map(c=>({...c,videos:(c.videos||[]).map(v=>({...v,url:v.cloudUrl||""}))}))};});}catch(e){console.warn("Cloud load failed:",e);return[];}};

/* ═══ WAVEFORM ═══ */
const Waveform=({w,h,color,seed=0})=>{const bars=Math.max(4,Math.floor(w/3));const pts=[];let s=seed||1;for(let i=0;i<bars;i++){s=(s*16807+i*13)%2147483647;const n=(s%1000)/1000;const amp=0.2+n*0.8;pts.push(amp);}
  return(<svg width={w} height={h} viewBox={`0 0 ${w} ${h}`} style={{display:"block"}}>{pts.map((a,i)=>{const bw=w/bars;const bh=Math.max(1,a*h);return<rect key={i} x={i*bw} y={(h-bh)/2} width={Math.max(1,bw-1)} height={bh} fill={color} rx={0.5}/>;})}</svg>);};

/* ═══ DOWNLOAD HELPERS ═══ */
const downloadImage=(url,filename)=>{const a=document.createElement("a");a.href=url;a.download=filename||"image.jpg";a.target="_blank";a.rel="noopener";document.body.appendChild(a);a.click();document.body.removeChild(a);};

const sanitizeName=(s)=>s.replace(/[^a-zA-Z0-9_\-]/g,"_").replace(/_+/g,"_").replace(/^_|_$/g,"")||"Unnamed";

const downloadPlayerZip=async(player,onProgress)=>{
  if(typeof JSZip==="undefined"){alert("JSZip library not loaded. Please refresh and try again.");return{total:0,downloaded:0,missing:0};}
  const zip=new JSZip();
  const today=new Date().toISOString().slice(0,10);
  const rootName=sanitizeName(player.name)+"_Clips_"+today;
  const root=zip.folder(rootName);
  const missing=[];
  let totalFiles=0;let processed=0;
  player.categories.forEach(cat=>totalFiles+=cat.videos.length);
  if(onProgress)onProgress({phase:"fetching",pct:0,fetched:0,total:totalFiles});
  for(const cat of player.categories){
    const catFolder=root.folder(sanitizeName(cat.name));
    for(const vid of cat.videos){
      const url=vid.cloudUrl||vid.url;
      if(!url){missing.push({id:vid.id,name:vid.name,category:cat.name,reason:"No URL"});processed++;if(onProgress)onProgress({phase:"fetching",pct:Math.round(processed/Math.max(1,totalFiles)*100),fetched:processed,total:totalFiles});continue;}
      try{
        const resp=await fetch(url);
        if(!resp.ok)throw new Error("HTTP "+resp.status);
        const blob=await resp.blob();
        const ext=blob.type.includes("mp4")?"mp4":blob.type.includes("webm")?"webm":blob.type.includes("quicktime")?"mov":"mp4";
        const fname=sanitizeName(cat.name)+"_"+sanitizeName(vid.name)+"_"+vid.id+"."+ext;
        catFolder.file(fname,blob);
      }catch(e){
        missing.push({id:vid.id,name:vid.name,category:cat.name,reason:e.message});
      }
      processed++;
      if(onProgress)onProgress({phase:"fetching",pct:Math.round(processed/Math.max(1,totalFiles)*100),fetched:processed,total:totalFiles});
    }
  }
  if(missing.length>0){
    let txt="MISSING FILES REPORT\nGenerated: "+new Date().toISOString()+"\nAthlete: "+player.name+"\n\n";
    missing.forEach(m=>{txt+="- ["+m.category+"] "+m.name+" (id: "+m.id+") — "+m.reason+"\n";});
    root.file("MISSING_FILES.txt",txt);
  }
  if(onProgress)onProgress({phase:"zipping",pct:0,fetched:processed,total:totalFiles});
  const zipBlob=await zip.generateAsync({type:"blob",compression:"STORE"},meta=>{if(onProgress)onProgress({phase:"zipping",pct:Math.round(meta.percent),fetched:processed,total:totalFiles});});
  const a=document.createElement("a");a.href=URL.createObjectURL(zipBlob);a.download=rootName+".zip";document.body.appendChild(a);a.click();
  setTimeout(()=>{URL.revokeObjectURL(a.href);document.body.removeChild(a);},1000);
  return{total:totalFiles,downloaded:totalFiles-missing.length,missing:missing.length};
};

/* ═══ HASH ROUTING HELPERS ═══ */
const getHashRoute=()=>{const h=window.location.hash.replace(/^#\/?/,"").split("/")[0]||"";return h;};
const setHashRoute=(route)=>{window.location.hash=route?`/${route}`:"";};

/* ═══ PASSWORD MODAL (shared) ═══ */
function PasswordModal({onSuccess,onCancel}){
  const[pw,setPw]=useState("");const[pwErr,setPwErr]=useState(false);const[showPwText,setShowPwText]=useState(false);
  const submit=()=>{if(pw===STUDIO_PASSWORD){setPw("");saveSession();onSuccess();}else{setPwErr(true);setTimeout(()=>setPwErr(false),2000);}};
  return(<div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.7)",backdropFilter:"blur(8px)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:100}}
    onClick={e=>{if(e.target===e.currentTarget){onCancel();}}}>
    <div style={{background:"#0f0f1a",border:"1px solid #1a1a2e",borderRadius:16,padding:"36px 32px",width:360,animation:"fadeIn 0.3s ease-out",boxShadow:"0 20px 60px rgba(0,0,0,0.5)"}}>
      <div style={{textAlign:"center",marginBottom:24}}>
        <div style={{width:56,height:56,borderRadius:"50%",background:"linear-gradient(135deg,rgba(244,63,94,0.15),rgba(244,63,94,0.05))",border:"1px solid rgba(244,63,94,0.2)",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 16px"}}><LockIcon size={24} color={C.coral}/></div>
        <div style={{fontSize:18,fontWeight:800,color:"#fff",fontStyle:"italic",letterSpacing:1}}>STUDIO ACCESS</div>
        <div style={{fontSize:12,color:C.sub,marginTop:4}}>Enter the editor password to continue</div>
      </div>
      <div style={{position:"relative",marginBottom:16}}>
        <input type={showPwText?"text":"password"} value={pw} onChange={e=>setPw(e.target.value)}
          onKeyDown={e=>{if(e.key==="Enter")submit();if(e.key==="Escape")onCancel();}}
          placeholder="Password" autoFocus style={{...inputStyle,border:pwErr?"1px solid #ef4444":`1px solid ${C.s1}`,paddingRight:44}}/>
        <button onClick={()=>setShowPwText(!showPwText)} style={{position:"absolute",right:12,top:"50%",transform:"translateY(-50%)",...ib,color:C.overlay}}>
          {showPwText?<EyeOffIcon size={16}/>:<EyeIcon size={16}/>}
        </button>
      </div>
      {pwErr&&<div style={{color:"#ef4444",fontSize:12,marginBottom:12,textAlign:"center"}}>Incorrect password. Try again.</div>}
      <button onClick={submit} style={{width:"100%",padding:12,background:"linear-gradient(135deg,#f43f5e,#e11d48)",color:"#fff",border:"none",borderRadius:10,fontSize:14,fontWeight:700,cursor:"pointer",letterSpacing:1}}>ENTER STUDIO</button>
      <button onClick={onCancel} style={{width:"100%",padding:10,background:"transparent",color:C.sub,border:"none",borderRadius:8,fontSize:13,cursor:"pointer",marginTop:8}}>Cancel</button>
    </div>
  </div>);
}

/* ═══ SHARED LANDING BACKGROUND ═══ */
function LandingBg({children}){
  return(<div style={{width:"100vw",height:"100vh",background:C.base,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",fontFamily:"'Inter',sans-serif",position:"relative",overflow:"hidden"}}>
    <div style={{position:"absolute",top:"-20%",left:"-10%",width:"50%",height:"80%",background:"radial-gradient(ellipse,rgba(59,130,246,0.08) 0%,transparent 70%)",pointerEvents:"none"}}/>
    <div style={{position:"absolute",bottom:"-20%",right:"-10%",width:"50%",height:"80%",background:"radial-gradient(ellipse,rgba(244,63,94,0.08) 0%,transparent 70%)",pointerEvents:"none"}}/>
    <div style={{position:"absolute",inset:0,opacity:0.03,pointerEvents:"none",backgroundImage:"linear-gradient(rgba(255,255,255,0.1) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.1) 1px,transparent 1px)",backgroundSize:"60px 60px"}}/>
    {children}
    <div style={{position:"absolute",bottom:28,display:"flex",alignItems:"center",gap:8,color:C.overlay,fontSize:11,letterSpacing:2,textTransform:"uppercase"}}>
      <div style={{width:7,height:7,borderRadius:"50%",background:C.green,animation:"pulse 2s ease-in-out infinite"}}/>
      <span>System Online</span><span style={{margin:"0 4px"}}>&bull;</span><span>Powered by <span style={{color:C.text,fontWeight:700}}>ATHLETES USA</span></span>
    </div>
  </div>);
}

/* ═══════════ LANDING PAGE (default — both tiles, backward compat) ═══════════ */
function LandingPage({onEnterAthlete,onEnterStudio}){
  const[showPw,setShowPw]=useState(false);
  const[hov,setHov]=useState(null);
  const handleStudioClick=()=>{if(isSessionValid()){saveSession();onEnterStudio();}else{setShowPw(true);}};
  return(
  <LandingBg>
    <div style={{position:"relative",zIndex:1,textAlign:"center",animation:"fadeIn 0.8s ease-out"}}>
      <h1 style={{fontSize:"clamp(48px,8vw,96px)",fontWeight:900,letterSpacing:"-2px",lineHeight:1,marginBottom:8,fontStyle:"italic"}}>
        <span style={{color:"#fff"}}>ATHLETES</span><span style={{color:C.coral}}>USA</span>
      </h1>
      <div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:12,marginBottom:60}}>
        <div style={{width:60,height:1,background:"linear-gradient(90deg,transparent,#64748b)"}}/>
        <span style={{color:C.coral,fontSize:11}}>&#9889;</span>
        <span style={{color:C.sub,fontSize:12,fontWeight:600,letterSpacing:3,textTransform:"uppercase"}}>The Official Editor Suite</span>
        <span style={{color:C.coral,fontSize:11}}>&#9889;</span>
        <div style={{width:60,height:1,background:"linear-gradient(90deg,#64748b,transparent)"}}/>
      </div>
      <div style={{display:"flex",gap:32,justifyContent:"center",flexWrap:"wrap",padding:"0 24px"}}>
        <div onClick={onEnterAthlete} onMouseEnter={()=>setHov("a")} onMouseLeave={()=>setHov(null)}
          style={{width:280,padding:"48px 32px 36px",borderRadius:16,cursor:"pointer",transition:"all 0.3s",
            background:hov==="a"?"linear-gradient(135deg,rgba(59,130,246,0.12),rgba(15,15,26,0.95))":"linear-gradient(135deg,rgba(59,130,246,0.06),rgba(15,15,26,0.9))",
            border:hov==="a"?"1px solid rgba(59,130,246,0.4)":"1px solid rgba(59,130,246,0.15)",
            boxShadow:hov==="a"?"0 0 40px rgba(59,130,246,0.15)":"none",transform:hov==="a"?"translateY(-4px)":"none"}}>
          <div style={{width:72,height:72,borderRadius:"50%",background:"linear-gradient(135deg,#3b82f6,#2563eb)",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 24px",boxShadow:"0 0 30px rgba(59,130,246,0.3)"}}><UserIcon size={32} color="#fff"/></div>
          <div style={{fontSize:20,fontWeight:800,color:"#fff",letterSpacing:1,marginBottom:4,fontStyle:"italic"}}>ATHLETE</div>
          <div style={{fontSize:12,color:C.sub,fontWeight:500,letterSpacing:2,textTransform:"uppercase",marginBottom:24}}>Player Portal</div>
          <div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:6,color:C.blue,fontSize:12,fontWeight:700,letterSpacing:2,textTransform:"uppercase"}}>ENTER ZONE &rarr;</div>
        </div>
        <div onClick={handleStudioClick} onMouseEnter={()=>setHov("s")} onMouseLeave={()=>setHov(null)}
          style={{width:280,padding:"48px 32px 36px",borderRadius:16,cursor:"pointer",transition:"all 0.3s",
            background:hov==="s"?"linear-gradient(135deg,rgba(244,63,94,0.12),rgba(15,15,26,0.95))":"linear-gradient(135deg,rgba(244,63,94,0.04),rgba(15,15,26,0.9))",
            border:hov==="s"?"1px solid rgba(244,63,94,0.4)":"1px solid rgba(255,255,255,0.06)",
            boxShadow:hov==="s"?"0 0 40px rgba(244,63,94,0.12)":"none",transform:hov==="s"?"translateY(-4px)":"none"}}>
          <div style={{width:72,height:72,borderRadius:"50%",background:"linear-gradient(135deg,#374151,#1f2937)",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 24px",border:"1px solid #4b5563"}}><ClapperIcon size={30} color="#9ca3af"/></div>
          <div style={{fontSize:20,fontWeight:800,color:"#fff",letterSpacing:1,marginBottom:4,fontStyle:"italic"}}>STUDIO</div>
          <div style={{fontSize:12,color:C.sub,fontWeight:500,letterSpacing:2,textTransform:"uppercase",marginBottom:24}}>Production Suite</div>
          <div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:6,color:C.overlay,fontSize:12,fontWeight:700,letterSpacing:2,textTransform:"uppercase"}}><LockIcon size={12}/> ENTER STUDIO &rarr;</div>
        </div>
      </div>
    </div>
    {showPw&&<PasswordModal onSuccess={onEnterStudio} onCancel={()=>setShowPw(false)}/>}
  </LandingBg>);
}

/* ═══════════ ATHLETE LANDING PAGE (dedicated #/athlete entry) ═══════════ */
function AthleteLandingPage({onEnter}){
  const[hov,setHov]=useState(false);
  return(
  <LandingBg>
    <div style={{position:"relative",zIndex:1,textAlign:"center",animation:"fadeIn 0.8s ease-out"}}>
      <h1 style={{fontSize:"clamp(48px,8vw,96px)",fontWeight:900,letterSpacing:"-2px",lineHeight:1,marginBottom:8,fontStyle:"italic"}}>
        <span style={{color:"#fff"}}>ATHLETES</span><span style={{color:C.coral}}>USA</span>
      </h1>
      <div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:12,marginBottom:48}}>
        <div style={{width:60,height:1,background:"linear-gradient(90deg,transparent,#64748b)"}}/>
        <span style={{color:C.blue,fontSize:11}}>&#9889;</span>
        <span style={{color:C.sub,fontSize:12,fontWeight:600,letterSpacing:3,textTransform:"uppercase"}}>Player Portal</span>
        <span style={{color:C.blue,fontSize:11}}>&#9889;</span>
        <div style={{width:60,height:1,background:"linear-gradient(90deg,#64748b,transparent)"}}/>
      </div>
      <div onClick={onEnter} onMouseEnter={()=>setHov(true)} onMouseLeave={()=>setHov(false)}
        style={{width:320,padding:"48px 32px 36px",borderRadius:16,cursor:"pointer",transition:"all 0.3s",margin:"0 auto",
          background:hov?"linear-gradient(135deg,rgba(59,130,246,0.12),rgba(15,15,26,0.95))":"linear-gradient(135deg,rgba(59,130,246,0.06),rgba(15,15,26,0.9))",
          border:hov?"1px solid rgba(59,130,246,0.4)":"1px solid rgba(59,130,246,0.15)",
          boxShadow:hov?"0 0 40px rgba(59,130,246,0.15)":"none",transform:hov?"translateY(-4px)":"none"}}>
        <div style={{width:72,height:72,borderRadius:"50%",background:"linear-gradient(135deg,#3b82f6,#2563eb)",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 24px",boxShadow:"0 0 30px rgba(59,130,246,0.3)"}}><UserIcon size={32} color="#fff"/></div>
        <div style={{fontSize:22,fontWeight:800,color:"#fff",letterSpacing:1,marginBottom:4,fontStyle:"italic"}}>ATHLETE ZONE</div>
        <div style={{fontSize:12,color:C.sub,fontWeight:500,letterSpacing:2,textTransform:"uppercase",marginBottom:24}}>Manage your profile & highlights</div>
        <div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:6,color:C.blue,fontSize:13,fontWeight:700,letterSpacing:2,textTransform:"uppercase"}}>ENTER &rarr;</div>
      </div>
    </div>
  </LandingBg>);
}

/* ═══════════ STUDIO LANDING PAGE (dedicated #/studio entry) ═══════════ */
function StudioLandingPage({onEnterStudio,onEnterAthleteReview}){
  const[showPw,setShowPw]=useState(false);
  const[hov,setHov]=useState(null);
  const[authenticated,setAuthenticated]=useState(isSessionValid());
  const handleStudioClick=()=>{if(isSessionValid()){saveSession();onEnterStudio();}else{setShowPw(true);}};
  const handleAthleteClick=()=>{if(isSessionValid()){saveSession();onEnterAthleteReview();}else{setShowPw(true);}};
  const handlePwSuccess=()=>{setAuthenticated(true);setShowPw(false);saveSession();onEnterStudio();};
  return(
  <LandingBg>
    <div style={{position:"relative",zIndex:1,textAlign:"center",animation:"fadeIn 0.8s ease-out"}}>
      <h1 style={{fontSize:"clamp(48px,8vw,96px)",fontWeight:900,letterSpacing:"-2px",lineHeight:1,marginBottom:8,fontStyle:"italic"}}>
        <span style={{color:"#fff"}}>ATHLETES</span><span style={{color:C.coral}}>USA</span>
      </h1>
      <div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:12,marginBottom:48}}>
        <div style={{width:60,height:1,background:"linear-gradient(90deg,transparent,#64748b)"}}/>
        <span style={{color:C.coral,fontSize:11}}>&#9889;</span>
        <span style={{color:C.sub,fontSize:12,fontWeight:600,letterSpacing:3,textTransform:"uppercase"}}>Production Suite</span>
        <span style={{color:C.coral,fontSize:11}}>&#9889;</span>
        <div style={{width:60,height:1,background:"linear-gradient(90deg,#64748b,transparent)"}}/>
      </div>
      <div style={{display:"flex",gap:28,justifyContent:"center",flexWrap:"wrap",padding:"0 24px"}}>
        {/* Editor tile */}
        <div onClick={handleStudioClick} onMouseEnter={()=>setHov("s")} onMouseLeave={()=>setHov(null)}
          style={{width:280,padding:"48px 32px 36px",borderRadius:16,cursor:"pointer",transition:"all 0.3s",
            background:hov==="s"?"linear-gradient(135deg,rgba(244,63,94,0.12),rgba(15,15,26,0.95))":"linear-gradient(135deg,rgba(244,63,94,0.04),rgba(15,15,26,0.9))",
            border:hov==="s"?"1px solid rgba(244,63,94,0.4)":"1px solid rgba(255,255,255,0.06)",
            boxShadow:hov==="s"?"0 0 40px rgba(244,63,94,0.12)":"none",transform:hov==="s"?"translateY(-4px)":"none"}}>
          <div style={{width:72,height:72,borderRadius:"50%",background:"linear-gradient(135deg,#374151,#1f2937)",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 24px",border:"1px solid #4b5563"}}><ClapperIcon size={30} color="#9ca3af"/></div>
          <div style={{fontSize:20,fontWeight:800,color:"#fff",letterSpacing:1,marginBottom:4,fontStyle:"italic"}}>EDITOR</div>
          <div style={{fontSize:12,color:C.sub,fontWeight:500,letterSpacing:2,textTransform:"uppercase",marginBottom:24}}>Video Editing Suite</div>
          <div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:6,color:C.coral,fontSize:12,fontWeight:700,letterSpacing:2,textTransform:"uppercase"}}>{authenticated?"":<><LockIcon size={12}/>{" "}</>}OPEN EDITOR &rarr;</div>
        </div>
        {/* Athlete review tile (editors can review athlete profiles) */}
        <div onClick={handleAthleteClick} onMouseEnter={()=>setHov("a")} onMouseLeave={()=>setHov(null)}
          style={{width:280,padding:"48px 32px 36px",borderRadius:16,cursor:"pointer",transition:"all 0.3s",
            background:hov==="a"?"linear-gradient(135deg,rgba(59,130,246,0.12),rgba(15,15,26,0.95))":"linear-gradient(135deg,rgba(59,130,246,0.06),rgba(15,15,26,0.9))",
            border:hov==="a"?"1px solid rgba(59,130,246,0.4)":"1px solid rgba(59,130,246,0.15)",
            boxShadow:hov==="a"?"0 0 40px rgba(59,130,246,0.15)":"none",transform:hov==="a"?"translateY(-4px)":"none"}}>
          <div style={{width:72,height:72,borderRadius:"50%",background:"linear-gradient(135deg,#3b82f6,#2563eb)",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 24px",boxShadow:"0 0 30px rgba(59,130,246,0.3)"}}><UsersIcon size={30} color="#fff"/></div>
          <div style={{fontSize:20,fontWeight:800,color:"#fff",letterSpacing:1,marginBottom:4,fontStyle:"italic"}}>ATHLETES</div>
          <div style={{fontSize:12,color:C.sub,fontWeight:500,letterSpacing:2,textTransform:"uppercase",marginBottom:24}}>Review & Support</div>
          <div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:6,color:C.blue,fontSize:12,fontWeight:700,letterSpacing:2,textTransform:"uppercase"}}>{authenticated?"":<><LockIcon size={12}/>{" "}</>}VIEW ATHLETES &rarr;</div>
        </div>
      </div>
    </div>
    {showPw&&<PasswordModal onSuccess={handlePwSuccess} onCancel={()=>setShowPw(false)}/>}
  </LandingBg>);
}

/* ═══════════ ATHLETE: PROFILE SELECT ═══════════ */
function AthleteSelect({players,isEditorMode,onSelect,onCreate,onBack,onDelete}){
  const[confirmDel,setConfirmDel]=useState(null);
  /* Athletes see only "Create Profile" (no list). Editors see all players. */
  const visiblePlayers=isEditorMode?players:[];
  return(
  <div style={{position:"fixed",top:0,left:0,right:0,bottom:0,background:C.base,display:"flex",flexDirection:"column",fontFamily:"'Inter',sans-serif",overflow:"hidden"}}>
    <div className="ath-select-header" style={{display:"flex",alignItems:"center",padding:"0 16px",height:48,background:C.mantle,borderBottom:`1px solid ${C.s0}`,flexShrink:0}}>
      <button onClick={onBack} style={{...ib,color:C.sub,marginRight:12}}><ArrowLeftIcon size={18}/></button>
      <div style={{width:1,height:24,background:C.s0,marginRight:14}}/>
      <span style={{fontWeight:900,fontSize:15,color:"#fff",fontStyle:"italic",marginRight:4}}>ATHLETES</span>
      <span style={{fontWeight:900,fontSize:15,color:C.coral,fontStyle:"italic",marginRight:16}}>USA</span>
      <div style={{padding:"3px 10px",background:isEditorMode?C.coral+"18":C.blue+"18",border:`1px solid ${isEditorMode?C.coral:C.blue}33`,borderRadius:6}}>
        <span style={{fontSize:10,fontWeight:700,color:isEditorMode?C.coral:C.blue,letterSpacing:2}}>{isEditorMode?"EDITOR VIEW":"ATHLETE"}</span>
      </div>
    </div>
    <div className="ath-select-wrap" style={{flex:1,overflow:"auto",WebkitOverflowScrolling:"touch",display:"flex",alignItems:"center",justifyContent:"center",padding:32}}>
      <div style={{maxWidth:800,width:"100%",textAlign:"center"}}>
        <UsersIcon size={40} color={C.blue} style={{margin:"0 auto 16px",display:"block"}}/>
        <h2 style={{color:C.text,fontSize:24,fontWeight:800,marginBottom:8}}>{isEditorMode?"All Athletes":"Welcome, Player"}</h2>
        <p style={{color:C.sub,fontSize:14,marginBottom:36}}>{isEditorMode?"Review and manage athlete profiles.":"Create your profile to start uploading highlights."}</p>
        {visiblePlayers.length>0&&(
          <div className="ath-select-grid" style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(220px,1fr))",gap:16,marginBottom:32}}>
            {visiblePlayers.map((pl,i)=>(
              <div key={pl.id} style={{background:C.mantle,border:`1px solid ${C.s0}`,borderRadius:12,padding:"16px 16px 14px",cursor:"pointer",transition:"all 0.2s",textAlign:"center",position:"relative"}}
                onMouseEnter={e=>{e.currentTarget.style.borderColor=PLAYER_COLORS[i%8]+"66";e.currentTarget.style.transform="translateY(-2px)";}}
                onMouseLeave={e=>{e.currentTarget.style.borderColor=C.s0;e.currentTarget.style.transform="none";}}>
                {isEditorMode&&<button onClick={e=>{e.stopPropagation();setConfirmDel(pl.id);}} style={{position:"absolute",top:8,right:8,...ib,color:C.overlay,padding:3,zIndex:2}} title="Delete profile"
                  onMouseEnter={e=>e.currentTarget.style.color=C.red} onMouseLeave={e=>e.currentTarget.style.color=C.overlay}><Trash2Icon size={13}/></button>}
                <div onClick={()=>onSelect(pl.id)}>
                  {pl.profilePicUrl?
                    <img src={pl.profilePicUrl} style={{width:56,height:56,borderRadius:"50%",objectFit:"cover",border:`2px solid ${PLAYER_COLORS[i%8]}`,margin:"0 auto 10px",display:"block"}}/>
                  :<div style={{width:56,height:56,borderRadius:"50%",background:PLAYER_COLORS[i%8]+"22",border:`2px solid ${PLAYER_COLORS[i%8]}`,display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 10px"}}>
                    <span style={{color:PLAYER_COLORS[i%8],fontWeight:800,fontSize:20}}>{pl.name.charAt(0).toUpperCase()}</span>
                  </div>}
                  <div style={{color:C.text,fontSize:14,fontWeight:700,marginBottom:2}}>{pl.name}</div>
                  <div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:6,marginBottom:4}}>
                    {pl.shirtNumber&&<span style={{background:C.blue+"22",color:C.blue,fontSize:10,fontWeight:700,padding:"2px 8px",borderRadius:4}}>#{pl.shirtNumber}</span>}
                    <span style={{color:C.overlay,fontSize:11}}>Class {pl.recruitingClass}</span>
                  </div>
                  {pl.positions&&pl.positions.length>0&&<div style={{display:"flex",flexWrap:"wrap",justifyContent:"center",gap:3,marginBottom:4}}>{pl.positions.map(p=><span key={p} style={{background:C.green+"22",color:C.green||"#a6e3a1",fontSize:8,fontWeight:700,padding:"1px 6px",borderRadius:3}}>{p}</span>)}</div>}
                  {pl.uniformDesc&&<div style={{color:C.overlay,fontSize:9,marginBottom:4,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{pl.uniformDesc}</div>}
                  <div style={{color:C.overlay,fontSize:10}}>{pl.categories.reduce((a,c)=>a+c.videos.length,0)} clips uploaded</div>
                </div>
                {pl.playingPicUrl&&<div style={{marginTop:8,borderRadius:6,overflow:"hidden",height:80}}>
                  <img src={pl.playingPicUrl} style={{width:"100%",height:"100%",objectFit:"cover",opacity:0.6}}/>
                </div>}
              </div>
            ))}
          </div>
        )}
        <button onClick={onCreate}
          style={{display:"inline-flex",alignItems:"center",gap:8,background:C.blue,color:"#fff",border:"none",borderRadius:10,padding:"12px 28px",fontSize:14,fontWeight:700,cursor:"pointer",letterSpacing:1}}>
          <PlusIcon size={16}/> Create New Profile
        </button>
      </div>
    </div>
    {confirmDel&&<div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.7)",backdropFilter:"blur(8px)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:100}}
      onClick={e=>{if(e.target===e.currentTarget)setConfirmDel(null);}}>
      <div style={{background:C.mantle,border:`1px solid ${C.s0}`,borderRadius:16,padding:"32px 28px",width:380,textAlign:"center",animation:"fadeIn 0.3s ease-out",boxShadow:"0 20px 60px rgba(0,0,0,0.5)"}}>
        <div style={{width:52,height:52,borderRadius:"50%",background:C.red+"18",border:`1px solid ${C.red}33`,display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 16px"}}><Trash2Icon size={24} color={C.red}/></div>
        <div style={{fontSize:18,fontWeight:800,color:"#fff",marginBottom:4}}>Delete Profile?</div>
        <div style={{color:C.sub,fontSize:13,marginBottom:24}}>This will permanently remove the player profile and all their uploaded clips from the cloud. This cannot be undone.</div>
        <div style={{display:"flex",gap:10}}>
          <button onClick={()=>setConfirmDel(null)} style={{flex:1,padding:12,background:"transparent",border:`1px solid ${C.s1}`,borderRadius:10,color:C.sub,cursor:"pointer",fontSize:14,fontWeight:600}}>Cancel</button>
          <button onClick={()=>{onDelete(confirmDel);setConfirmDel(null);}} style={{flex:1,padding:12,background:"linear-gradient(135deg,#ef4444,#dc2626)",border:"none",borderRadius:10,color:"#fff",cursor:"pointer",fontSize:14,fontWeight:700,letterSpacing:0.5}}>Delete</button>
        </div>
      </div>
    </div>}
  </div>);
}

/* ═══════════ ATHLETE: PROFILE FORM ═══════════ */
function AthleteProfileForm({onSubmit,onBack}){
  const[name,setName]=useState("");const[rc,setRc]=useState("2026");const[size,setSize]=useState("");const[dob,setDob]=useState("");
  const[shirtNum,setShirtNum]=useState("");const[uniformDesc,setUniformDesc]=useState("");
  const ALL_POSITIONS=["GK","LCB","CB","RCB","LB","LWB","RB","RWB","CDM","CM","CAM","LM","RM","LW","RW","ST","CF","SS"];
  const[positions,setPositions]=useState([]);
  const togglePos=p=>setPositions(prev=>prev.includes(p)?prev.filter(x=>x!==p):[...prev,p]);
  const[profilePic,setProfilePic]=useState(null);const[profilePicPrev,setProfilePicPrev]=useState(null);
  const[playingPic,setPlayingPic]=useState(null);const[playingPicPrev,setPlayingPicPrev]=useState(null);
  const[creating,setCreating]=useState(false);const[createProg,setCreateProg]=useState("");
  const profRef=useRef(null);const playRef=useRef(null);

  const onPickProfile=e=>{const f=e.target.files[0];if(!f)return;setProfilePic(f);setProfilePicPrev(URL.createObjectURL(f));};
  const onPickPlaying=e=>{const f=e.target.files[0];if(!f)return;setPlayingPic(f);setPlayingPicPrev(URL.createObjectURL(f));};

  const handle=async()=>{if(!name.trim()||creating)return;
    setCreating(true);
    let profilePicUrl="",playingPicUrl="";
    try{
      if(profilePic){setCreateProg("Uploading profile picture...");const id=uid("ppic");profilePicUrl=await uploadVideoToCloud(id,profilePic,()=>{});}
      if(playingPic){setCreateProg("Uploading playing picture...");const id=uid("apic");playingPicUrl=await uploadVideoToCloud(id,playingPic,()=>{});}
    }catch(e){console.warn("Pic upload failed:",e);}
    setCreateProg("Creating profile...");
    onSubmit({name:name.trim(),recruitingClass:rc,size:size.trim(),dob,shirtNumber:shirtNum.trim(),uniformDesc:uniformDesc.trim(),positions,profilePicUrl,playingPicUrl});
    setCreating(false);
  };

  const canSubmit=name.trim()&&!creating;
  const labelStyle={color:C.sub,fontSize:12,fontWeight:600,marginBottom:6,display:"block",letterSpacing:1,textTransform:"uppercase"};
  const picBoxStyle=(hasImg)=>({width:"100%",height:140,borderRadius:12,border:`2px dashed ${hasImg?C.blue+"66":C.s1}`,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",cursor:"pointer",background:hasImg?"transparent":C.s0,overflow:"hidden",position:"relative",transition:"border 0.2s"});
  return(
  <div style={{position:"fixed",top:0,left:0,right:0,bottom:0,background:C.base,display:"flex",flexDirection:"column",fontFamily:"'Inter',sans-serif",overflow:"hidden"}}>
    <input ref={profRef} type="file" accept="image/*" onChange={onPickProfile} style={{display:"none"}}/>
    <input ref={playRef} type="file" accept="image/*" onChange={onPickPlaying} style={{display:"none"}}/>
    <div style={{display:"flex",alignItems:"center",padding:"0 16px",height:48,background:C.mantle,borderBottom:`1px solid ${C.s0}`,flexShrink:0}}>
      <button onClick={onBack} style={{...ib,color:C.sub,marginRight:12}}><ArrowLeftIcon size={18}/></button>
      <div style={{width:1,height:24,background:C.s0,marginRight:14}}/>
      <span style={{fontWeight:900,fontSize:15,color:"#fff",fontStyle:"italic",marginRight:4}}>ATHLETES</span>
      <span style={{fontWeight:900,fontSize:15,color:C.coral,fontStyle:"italic",marginRight:16}}>USA</span>
      <span style={{color:C.sub,fontSize:12}}>New Player Profile</span>
    </div>
    <div className="ath-form-wrap" style={{flex:1,overflow:"auto",WebkitOverflowScrolling:"touch",display:"flex",justifyContent:"center",padding:32}}>
      <div style={{maxWidth:560,width:"100%",animation:"fadeIn 0.5s ease-out"}}>
        <div style={{textAlign:"center",marginBottom:28}}>
          {profilePicPrev?<img src={profilePicPrev} style={{width:72,height:72,borderRadius:"50%",objectFit:"cover",border:`3px solid ${C.blue}`,margin:"0 auto 12px",display:"block"}}/>
          :<div style={{width:72,height:72,borderRadius:"50%",background:"linear-gradient(135deg,#3b82f6,#2563eb)",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 12px"}}><UserIcon size={30} color="#fff"/></div>}
          <h2 style={{color:C.text,fontSize:22,fontWeight:800}}>Create Your Profile</h2>
          <p style={{color:C.sub,fontSize:13,marginTop:4}}>Fill in your details so coaches and editors can identify you</p>
        </div>
        <div style={{display:"flex",flexDirection:"column",gap:18}}>
          <div>
            <label style={labelStyle}>Full Name *</label>
            <input value={name} onChange={e=>setName(e.target.value)} placeholder="e.g. Marcus Johnson" style={inputStyle}/>
          </div>
          <div className="ath-form-3col" style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:12}}>
            <div>
              <label style={labelStyle}>Shirt Number *</label>
              <input value={shirtNum} onChange={e=>setShirtNum(e.target.value.replace(/\D/g,"").slice(0,3))} placeholder="e.g. 10" style={inputStyle} maxLength={3}/>
            </div>
            <div>
              <label style={labelStyle}>Recruiting Class</label>
              <select value={rc} onChange={e=>setRc(e.target.value)} style={{...inputStyle,cursor:"pointer"}}>
                {["2024","2025","2026","2027","2028","2029","2030"].map(y=><option key={y} value={y}>{y}</option>)}
              </select>
            </div>
            <div>
              <label style={labelStyle}>Height / Size</label>
              <input value={size} onChange={e=>setSize(e.target.value)} placeholder="5'11&quot;" style={inputStyle}/>
            </div>
          </div>
          <div>
            <label style={labelStyle}>Positions Played</label>
            <div style={{display:"flex",flexWrap:"wrap",gap:6}}>
              {ALL_POSITIONS.map(p=><button key={p} type="button" onClick={()=>togglePos(p)} style={{padding:"5px 12px",borderRadius:6,fontSize:11,fontWeight:700,cursor:"pointer",border:positions.includes(p)?`2px solid ${C.blue}`:`2px solid ${C.s1}`,background:positions.includes(p)?C.blue+"22":"transparent",color:positions.includes(p)?C.blue:C.sub,transition:"all 0.15s"}}>{p}</button>)}
            </div>
            {positions.length>0&&<div style={{color:C.overlay,fontSize:10,marginTop:6}}>Selected: {positions.join(", ")}</div>}
          </div>
          <div>
            <label style={labelStyle}>Uniform Description</label>
            <input value={uniformDesc} onChange={e=>setUniformDesc(e.target.value)} placeholder="e.g. White home jersey, blue shorts, #10 on back" style={inputStyle}/>
          </div>
          <div>
            <label style={labelStyle}>Date of Birth</label>
            <input type="date" value={dob} onChange={e=>setDob(e.target.value)} style={{...inputStyle,colorScheme:"dark"}}/>
          </div>
          <div className="ath-form-2col" style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:16}}>
            <div>
              <label style={labelStyle}>Profile Picture</label>
              <div onClick={()=>profRef.current?.click()} style={picBoxStyle(!!profilePicPrev)}
                onMouseEnter={e=>e.currentTarget.style.borderColor=C.blue} onMouseLeave={e=>e.currentTarget.style.borderColor=profilePicPrev?C.blue+"66":C.s1}>
                {profilePicPrev?<img src={profilePicPrev} style={{width:"100%",height:"100%",objectFit:"cover"}}/>
                :<><UserIcon size={28} color={C.s2}/><span style={{color:C.overlay,fontSize:10,marginTop:6}}>Click to upload</span><span style={{color:C.s2,fontSize:9}}>Headshot / Portrait</span></>}
              </div>
            </div>
            <div>
              <label style={labelStyle}>Playing Picture</label>
              <div onClick={()=>playRef.current?.click()} style={picBoxStyle(!!playingPicPrev)}
                onMouseEnter={e=>e.currentTarget.style.borderColor=C.coral} onMouseLeave={e=>e.currentTarget.style.borderColor=playingPicPrev?C.coral+"66":C.s1}>
                {playingPicPrev?<img src={playingPicPrev} style={{width:"100%",height:"100%",objectFit:"cover"}}/>
                :<><FilmIcon size={28} color={C.s2}/><span style={{color:C.overlay,fontSize:10,marginTop:6}}>Click to upload</span><span style={{color:C.s2,fontSize:9}}>Action / Game Shot</span></>}
              </div>
            </div>
          </div>
          <button onClick={handle} disabled={!canSubmit}
            style={{width:"100%",padding:14,background:canSubmit?"linear-gradient(135deg,#3b82f6,#2563eb)":"#1a1a2e",color:canSubmit?"#fff":"#64748b",
              border:"none",borderRadius:10,fontSize:15,fontWeight:700,cursor:canSubmit?"pointer":"not-allowed",marginTop:4,letterSpacing:1}}>
            {creating?createProg:"CREATE PROFILE"}
          </button>
        </div>
      </div>
    </div>
  </div>);
}

/* ═══════════ ATHLETE: UPLOAD PORTAL ═══════════ */
function AthletePortal({player,onUpdatePlayer,onBack,isEditorMode}){
  const[editCat,setEditCat]=useState(null);const[editName,setEditName]=useState("");
  const[showAdd,setShowAdd]=useState(false);const[newCat,setNewCat]=useState("");
  const[uploadCat,setUploadCat]=useState(null);const fileRef=useRef(null);
  const[dragIdx,setDragIdx]=useState(null);const[overIdx,setOverIdx]=useState(null);
  const[uploadProg,setUploadProg]=useState(null);
  const[zipProg,setZipProg]=useState(null);
  const handleZipDownload=async()=>{
    const totalClips=player.categories.reduce((s,c)=>s+c.videos.length,0);
    if(totalClips===0&&!confirm("This athlete has no clips. Download zip with empty category folders?"))return;
    setZipProg({phase:"fetching",pct:0,fetched:0,total:totalClips});
    try{
      const result=await downloadPlayerZip(player,setZipProg);
      setZipProg(null);
      if(result.missing>0)alert("Download complete. "+result.downloaded+"/"+result.total+" clips downloaded. "+result.missing+" file(s) missing — see MISSING_FILES.txt in the zip.");
    }catch(e){console.error("Zip error:",e);setZipProg(null);alert("Zip download failed: "+e.message);}
  };

  const handleUpload=async(catId,files)=>{
    const vids=[];
    for(let i=0;i<files.length;i++){const f=files[i];const id=uid("vid");const url=URL.createObjectURL(f);const dur=await getMediaDur(url);
      setUploadProg({cur:i+1,total:files.length,pct:0,name:f.name});
      let cloudUrl="";
      try{cloudUrl=await uploadVideoToCloud(id,f,pct=>setUploadProg(p=>({...p,pct})));}catch(e){console.warn("Cloud upload failed:",e);}
      await storeBlob(id,f);
      vids.push({id,name:f.name.replace(/\.[^.]+$/,""),url,duration:dur,cloudUrl});}
    setUploadProg(null);
    const updated={...player,categories:player.categories.map(c=>c.id===catId?{...c,videos:[...c.videos,...vids]}:c)};
    onUpdatePlayer(updated);
    savePlayerToCloud(updated);
  };
  const trigUpload=catId=>{setUploadCat(catId);if(fileRef.current){fileRef.current.value="";fileRef.current.click();}};
  const onFile=e=>{if(uploadCat&&e.target.files.length>0)handleUpload(uploadCat,Array.from(e.target.files));};
  const addCat=name=>{if(!name.trim())return;const updated={...player,categories:[...player.categories,{id:uid("cat"),name:name.trim(),videos:[]}]};onUpdatePlayer(updated);savePlayerToCloud(updated);setNewCat("");setShowAdd(false);};
  const renameCat=(catId,name)=>{if(!name.trim())return;const updated={...player,categories:player.categories.map(c=>c.id===catId?{...c,name:name.trim()}:c)};onUpdatePlayer(updated);savePlayerToCloud(updated);setEditCat(null);};
  const removeVid=(catId,vidId)=>{deleteBlob(vidId).catch(()=>{});deleteVideoFromCloud(vidId).catch(()=>{});const updated={...player,categories:player.categories.map(c=>c.id===catId?{...c,videos:c.videos.filter(v=>v.id!==vidId)}:c)};onUpdatePlayer(updated);savePlayerToCloud(updated);};

  const handleCatDragStart=(e,idx)=>{setDragIdx(idx);e.dataTransfer.effectAllowed="move";};
  const handleCatDragOver=(e,idx)=>{e.preventDefault();if(dragIdx===null||dragIdx===idx)return;setOverIdx(idx);};
  const handleCatDrop=(e,idx)=>{e.preventDefault();if(dragIdx===null||dragIdx===idx){setDragIdx(null);setOverIdx(null);return;}
    const cats=[...player.categories];const[moved]=cats.splice(dragIdx,1);cats.splice(idx,0,moved);
    const updated={...player,categories:cats};onUpdatePlayer(updated);savePlayerToCloud(updated);setDragIdx(null);setOverIdx(null);};
  const handleCatDragEnd=()=>{setDragIdx(null);setOverIdx(null);};

  return(
  <div style={{position:"fixed",top:0,left:0,right:0,bottom:0,background:C.base,display:"flex",flexDirection:"column",fontFamily:"'Inter',sans-serif",overflow:"hidden"}}>
    <input ref={fileRef} type="file" accept="video/*" multiple onChange={onFile} style={{display:"none"}}/>
    <div className="ath-header" style={{padding:"24px 40px 0",flexShrink:0}}>
      <div className="ath-header-row" style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:4}}>
        <div className="ath-header-row" style={{display:"flex",alignItems:"center",gap:12,flex:1,minWidth:0}}>
          {player.profilePicUrl?<img src={player.profilePicUrl} style={{width:40,height:40,borderRadius:"50%",objectFit:"cover",border:`2px solid ${C.blue}`,flexShrink:0}}/>
          :<div style={{width:40,height:40,borderRadius:"50%",background:C.blue+"22",border:`2px solid ${C.blue}`,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}><span style={{color:C.blue,fontWeight:800,fontSize:16}}>{player.name.charAt(0)}</span></div>}
          <div style={{minWidth:0}}>
            <div style={{display:"flex",alignItems:"center",gap:6,flexWrap:"wrap"}}>
              <span className="ath-header-info" style={{fontWeight:800,fontSize:18,color:"#fff"}}>{player.name}</span>
              {player.shirtNumber&&<span style={{background:C.blue+"22",color:C.blue,fontSize:11,fontWeight:700,padding:"2px 8px",borderRadius:4}}>#{player.shirtNumber}</span>}
            </div>
            <div style={{display:"flex",alignItems:"center",gap:4,marginTop:2,flexWrap:"wrap"}}>
              <span style={{color:C.overlay,fontSize:11}}>Class {player.recruitingClass}</span>
              {player.positions&&player.positions.length>0&&<><span style={{color:C.s1}}>&bull;</span>{player.positions.map(p=><span key={p} style={{background:C.green+"22",color:C.green||"#a6e3a1",fontSize:9,fontWeight:700,padding:"1px 6px",borderRadius:3}}>{p}</span>)}</>}
              {player.uniformDesc&&<><span style={{color:C.s1}}>&bull;</span><span style={{color:C.overlay,fontSize:11}}>{player.uniformDesc}</span></>}
            </div>
          </div>
          <div className="ath-brand-sep" style={{width:1,height:28,background:C.s1,margin:"0 4px",flexShrink:0}}/>
          <span className="ath-brand" style={{fontWeight:900,fontSize:16,color:"#fff",fontStyle:"italic",flexShrink:0}}>ATHLETES</span>
          <span className="ath-brand" style={{fontWeight:900,fontSize:16,color:C.coral,fontStyle:"italic",flexShrink:0}}>USA</span>
        </div>
        <div style={{display:"flex",alignItems:"center",gap:8,flexShrink:0}}>
          {isEditorMode&&<button className="ath-zip-btn" onClick={handleZipDownload} disabled={!!zipProg}
            style={{display:"flex",alignItems:"center",gap:6,background:C.green+"18",border:`1px solid ${C.green}44`,borderRadius:8,padding:"8px 16px",color:C.green,cursor:zipProg?"wait":"pointer",fontSize:12,fontWeight:600,letterSpacing:0.5,flexShrink:0,opacity:zipProg?0.6:1}}
            onMouseEnter={e=>{if(!zipProg)e.currentTarget.style.background=C.green+"30";}} onMouseLeave={e=>{e.currentTarget.style.background=C.green+"18";}}>
            <DownloadIcon size={14}/> Download All Clips
          </button>}
          <button className="ath-signout" onClick={onBack} style={{display:"flex",alignItems:"center",gap:8,background:"transparent",border:`1px solid ${C.s1}`,borderRadius:8,padding:"8px 18px",color:C.sub,cursor:"pointer",fontSize:12,fontWeight:600,letterSpacing:1,flexShrink:0}}>
            <LogOutIcon size={14}/> Sign Out
          </button>
        </div>
      </div>
      <div className="ath-photos-row" style={{display:"flex",gap:8,marginTop:8,marginBottom:4,alignItems:"center",flexWrap:"wrap"}}>
        <span style={{color:C.overlay,fontSize:11,fontWeight:600}}>Photos:</span>
        {player.profilePicUrl?<button onClick={()=>downloadImage(player.profilePicUrl,`${player.name.replace(/\s+/g,"_")}_profile.jpg`)} style={{...tb,background:C.blue+"18",border:`1px solid ${C.blue}33`,color:C.blue,fontSize:11,padding:"4px 12px"}}><DownloadIcon size={12}/> Profile Pic</button>
        :<span style={{color:C.overlay,fontSize:11,fontStyle:"italic"}}>No profile pic</span>}
        {player.playingPicUrl?<button onClick={()=>downloadImage(player.playingPicUrl,`${player.name.replace(/\s+/g,"_")}_action.jpg`)} style={{...tb,background:C.coral+"18",border:`1px solid ${C.coral}33`,color:C.coral,fontSize:11,padding:"4px 12px"}}><DownloadIcon size={12}/> Action Pic</button>
        :<span style={{color:C.overlay,fontSize:11,fontStyle:"italic"}}>No action pic</span>}
      </div>
      <div className="ath-desc" style={{color:C.sub,fontSize:13,marginBottom:16}}>Athlete Portal &bull; Media Management &bull; <span style={{color:C.green}}>&#9679; Cloud Sync</span></div>
      <div style={{height:1,background:`linear-gradient(90deg,${C.blue}44,${C.coral}44)`,marginBottom:0}}/>
    </div>

    <div className="ath-cats-scroll" style={{flex:1,overflowX:"auto",overflowY:"hidden",WebkitOverflowScrolling:"touch",padding:"32px 40px"}}>
      <div className="ath-cats-flex" style={{display:"flex",gap:20,height:"100%",alignItems:"stretch"}}>
        {player.categories.map((cat,ci)=>{const color=CAT_COLORS[ci%CAT_COLORS.length];const isDrag=dragIdx===ci;const isOver=overIdx===ci&&dragIdx!==ci;
        return(
          <div key={cat.id} className="ath-cat-card" draggable onDragStart={e=>handleCatDragStart(e,ci)} onDragOver={e=>handleCatDragOver(e,ci)} onDrop={e=>handleCatDrop(e,ci)} onDragEnd={handleCatDragEnd}
            style={{minWidth:260,width:260,flexShrink:0,display:"flex",flexDirection:"column",background:C.s0,borderRadius:12,border:isOver?`2px solid ${C.blue}`:`1px solid ${C.s1}`,overflow:"hidden",opacity:isDrag?0.5:1,transition:"opacity 0.2s, border 0.2s"}}>
            <div style={{display:"flex",alignItems:"center",padding:"12px 14px",borderBottom:`1px solid ${C.s1}`,flexShrink:0,cursor:"grab"}}>
              <GripIcon size={14} color={C.overlay} style={{marginRight:8,flexShrink:0}}/>
              {editCat===cat.id?(
                <div style={{display:"flex",alignItems:"center",gap:4,flex:1}}>
                  <input value={editName} onChange={e=>setEditName(e.target.value)} onKeyDown={e=>{if(e.key==="Enter")renameCat(cat.id,editName);if(e.key==="Escape")setEditCat(null);}}
                    autoFocus onClick={e=>e.stopPropagation()} style={{...inputStyle,fontSize:14,fontWeight:700,flex:1,padding:"4px 8px"}}/>
                  <button onClick={()=>renameCat(cat.id,editName)} style={{...ib,color:C.green}}><CheckIcon size={14}/></button>
                  <button onClick={()=>setEditCat(null)} style={{...ib,color:C.red}}><XIcon size={14}/></button>
                </div>
              ):(
                <>
                  <span style={{color:"#fff",fontSize:14,fontWeight:700,flex:1}}>{cat.name}</span>
                  <button onClick={e=>{e.stopPropagation();setEditCat(cat.id);setEditName(cat.name);}} style={{...ib,color:C.overlay}}><Edit3Icon size={14}/></button>
                </>
              )}
            </div>
            <div style={{flex:1,padding:10,overflow:"auto",display:"flex",flexDirection:"column",gap:5}}>
              {cat.videos.length===0&&(
                <div style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",color:C.overlay,fontSize:12,gap:8}}>
                  <FilmIcon size={28} color={C.s2}/><span>No clips uploaded</span>
                </div>
              )}
              {cat.videos.map(v=>(
                <div key={v.id} style={{display:"flex",alignItems:"center",gap:6,background:C.mantle,borderRadius:8,padding:"7px 10px",border:`1px solid ${C.s1}`}}>
                  <FilmIcon size={11} color={color}/>
                  <span style={{color:C.text,fontSize:11,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1}}>{v.name}</span>
                  <span style={{color:C.overlay,fontSize:9,flexShrink:0}}>{fmtTime(v.duration)}</span>
                  <button onClick={()=>removeVid(cat.id,v.id)} style={{...ib,color:C.overlay,padding:2}}><XIcon size={11}/></button>
                </div>
              ))}
            </div>
            <div style={{padding:10,flexShrink:0}}>
              <button onClick={()=>trigUpload(cat.id)}
                style={{width:"100%",display:"flex",alignItems:"center",justifyContent:"center",gap:8,
                  background:C.coral,color:"#fff",border:"none",borderRadius:8,padding:"11px 16px",cursor:"pointer",fontSize:13,fontWeight:700,letterSpacing:0.5}}
                onMouseEnter={e=>e.currentTarget.style.opacity="0.85"} onMouseLeave={e=>e.currentTarget.style.opacity="1"}>
                <UploadIcon size={15}/> Upload Media
              </button>
            </div>
          </div>
        );})}
      </div>
    </div>
    <div style={{flexShrink:0,padding:"12px 40px 16px"}}>
      {showAdd?(
        <div style={{display:"flex",alignItems:"center",gap:10,background:C.s0+"88",borderRadius:12,border:`1px dashed ${C.s1}`,padding:"12px 16px"}}>
          <input value={newCat} onChange={e=>setNewCat(e.target.value)} placeholder="Category name..."
            onKeyDown={e=>{if(e.key==="Enter")addCat(newCat);if(e.key==="Escape")setShowAdd(false);}}
            autoFocus style={{...inputStyle,fontSize:14,fontWeight:600,flex:1}}/>
          <button onClick={()=>addCat(newCat)} style={{display:"flex",alignItems:"center",justifyContent:"center",gap:4,background:C.green+"22",color:C.green,border:`1px solid ${C.green}44`,borderRadius:8,padding:"8px 16px",cursor:"pointer",fontSize:12,fontWeight:600,whiteSpace:"nowrap"}}><CheckIcon size={14}/> Add</button>
          <button onClick={()=>{setShowAdd(false);setNewCat("");}} style={{display:"flex",alignItems:"center",justifyContent:"center",gap:4,background:C.red+"22",color:C.red,border:`1px solid ${C.red}44`,borderRadius:8,padding:"8px 16px",cursor:"pointer",fontSize:12,fontWeight:600,whiteSpace:"nowrap"}}><XIcon size={14}/> Cancel</button>
        </div>
      ):(
        <div onClick={()=>setShowAdd(true)}
          style={{display:"flex",alignItems:"center",justifyContent:"center",gap:10,background:`linear-gradient(135deg,${C.blue}12,${C.coral}12)`,border:`1px dashed ${C.blue}66`,borderRadius:12,cursor:"pointer",color:C.blue,padding:"16px 0",transition:"all 0.25s ease"}}
          onMouseEnter={e=>{e.currentTarget.style.background=`linear-gradient(135deg,${C.blue}22,${C.coral}22)`;e.currentTarget.style.borderColor=C.blue;e.currentTarget.style.transform="translateY(-1px)";}}
          onMouseLeave={e=>{e.currentTarget.style.background=`linear-gradient(135deg,${C.blue}12,${C.coral}12)`;e.currentTarget.style.borderColor=C.blue+"66";e.currentTarget.style.transform="none";}}>
          <div style={{width:28,height:28,borderRadius:"50%",background:C.blue+"22",display:"flex",alignItems:"center",justifyContent:"center"}}><PlusIcon size={16} color={C.blue}/></div>
          <span style={{fontSize:13,fontWeight:700,letterSpacing:1.5}}>ADD CATEGORY</span>
        </div>
      )}
    </div>
    {uploadProg&&<div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.75)",backdropFilter:"blur(8px)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:200}}>
      <div style={{background:C.mantle,border:`1px solid ${C.s0}`,borderRadius:16,padding:"36px 44px",width:420,textAlign:"center",animation:"fadeIn 0.3s ease-out",boxShadow:"0 20px 60px rgba(0,0,0,0.5)"}}>
        <div style={{width:56,height:56,borderRadius:"50%",background:"linear-gradient(135deg,#3b82f622,#3b82f608)",border:"1px solid #3b82f633",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 16px"}}><UploadIcon size={26} color={C.blue}/></div>
        <div style={{fontSize:16,fontWeight:800,color:"#fff",marginBottom:4,letterSpacing:0.5}}>UPLOADING TO CLOUD</div>
        <div style={{color:C.sub,fontSize:11,marginBottom:20}}>File {uploadProg.cur} of {uploadProg.total} — {uploadProg.name}</div>
        <div style={{background:C.s0,borderRadius:6,height:8,overflow:"hidden",marginBottom:8}}>
          <div style={{height:"100%",background:"linear-gradient(90deg,#3b82f6,#2563eb)",borderRadius:6,transition:"width 0.2s ease",width:`${Math.round((uploadProg.pct||0)*100)}%`}}/>
        </div>
        <div style={{color:C.overlay,fontSize:10}}>{Math.round((uploadProg.pct||0)*100)}% uploaded</div>
      </div>
    </div>}
    {zipProg&&<div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.75)",backdropFilter:"blur(8px)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:200}}>
      <div style={{background:C.mantle,border:`1px solid ${C.s0}`,borderRadius:16,padding:"36px 44px",width:420,textAlign:"center",animation:"fadeIn 0.3s ease-out",boxShadow:"0 20px 60px rgba(0,0,0,0.5)"}}>
        <div style={{width:56,height:56,borderRadius:"50%",background:"linear-gradient(135deg,#22c55e22,#22c55e08)",border:"1px solid #22c55e33",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 16px"}}><DownloadIcon size={26} color={C.green}/></div>
        <div style={{fontSize:16,fontWeight:800,color:"#fff",marginBottom:4,letterSpacing:0.5}}>{zipProg.phase==="fetching"?"DOWNLOADING CLIPS":"BUILDING ZIP"}</div>
        <div style={{color:C.sub,fontSize:11,marginBottom:20}}>{zipProg.phase==="fetching"?`Clip ${zipProg.fetched} of ${zipProg.total}`:"Compressing files..."}</div>
        <div style={{background:C.s0,borderRadius:6,height:8,overflow:"hidden",marginBottom:8}}>
          <div style={{height:"100%",background:"linear-gradient(90deg,#22c55e,#16a34a)",borderRadius:6,transition:"width 0.2s ease",width:`${zipProg.pct||0}%`}}/>
        </div>
        <div style={{color:C.overlay,fontSize:10}}>{zipProg.pct||0}%</div>
      </div>
    </div>}
  </div>);
}

/* ═══════════ EDITOR / STUDIO ═══════════ */
function StudioApp({players,onLogout,onRefreshPlayers}){
  const[tracks,setTracks]=useState([{id:uid("trk"),name:"V1",clips:[]},{id:uid("trk"),name:"V2",clips:[]},{id:uid("trk"),name:"V3",clips:[]}]);
  const[tagTrack,setTagTrack]=useState({id:uid("ttag"),name:"TAGS",clips:[]});
  const[audioTracks,setAudioTracks]=useState([{id:uid("atrk"),name:"A1",clips:[]}]);
  const[playhead,setPlayhead]=useState(0);const[zoom,setZoom]=useState(60);const[isPlaying,setIsPlaying]=useState(false);
  const[selectedClipId,setSelectedClipId]=useState(null);const[tool,setTool]=useState("select");
  const[history,setHistory]=useState([]);const[clipProps,setClipProps]=useState({});const[clipFeedback,setClipFeedback]=useState(()=>{try{return JSON.parse(localStorage.getItem("aua_clipFeedback")||"{}");}catch(e){return {};}});const[tlDur,setTlDur]=useState(120);
  const[showFeedbackPanel,setShowFeedbackPanel]=useState(false);
  const[expandedPlayers,setExpandedPlayers]=useState({});const[expandedCats,setExpandedCats]=useState({});
  const[activePlayerId,setActivePlayerId]=useState(null);
  const[editorVideos,setEditorVideos]=useState([]);const[editorMusic,setEditorMusic]=useState([]);const edMediaHydRef=useRef(false);
  const[exporting,setExporting]=useState(false);const[exportProgress,setExportProgress]=useState(0);const[exportFmt,setExportFmt]=useState("");const exportCancelRef=useRef(false);
  const[showEditorSection,setShowEditorSection]=useState(false);
  const[showGuide,setShowGuide]=useState(false);
  const[showTagMenu,setShowTagMenu]=useState(false);
  const[resizingClipId,setResizingClipId]=useState(null);const[resizingEdge,setResizingEdge]=useState(null);const[resizingTrackId,setResizingTrackId]=useState(null);
  const[spotlightMode,setSpotlightMode]=useState(null);
  const[magnetOn,setMagnetOn]=useState(true);const[snapOn,setSnapOn]=useState(true);const[snapLine,setSnapLine]=useState(null);const snapLineTimer=useRef(null);
  const audioRef=useRef(null);const tlScrollRef=useRef(null);const animRef=useRef(null);const lastTRef=useRef(null);const prevClipRef=useRef(null);const prevAudioRef=useRef(null);const prevTagRef=useRef(null);const previewRef=useRef(null);
  /* ═══ VIDEO POOL: one <video> per unique clip URL — never change src during playback ═══ */
  const videoPoolRef=useRef({});/* { [clipId]: HTMLVideoElement } */
  const videoContainerRef=useRef(null);
  const activeVideoRef=useRef(null);/* currently-visible video element */
  const edVidRef=useRef(null);const edMusicRef=useRef(null);

  const playerColor=i=>PLAYER_COLORS[i%PLAYER_COLORS.length];

  /* hydrate editor media from IndexedDB on mount */
  useEffect(()=>{(async()=>{try{
    const svRaw=localStorage.getItem(STORAGE_KEY_EDVIDS);const smRaw=localStorage.getItem(STORAGE_KEY_EDMUSIC);
    if(svRaw){const list=JSON.parse(svRaw);const hydV=[];for(const v of list){const blob=await getBlob(v.id);if(blob){hydV.push({...v,url:URL.createObjectURL(blob)});}};if(hydV.length)setEditorVideos(hydV);}
    if(smRaw){const list=JSON.parse(smRaw);const hydM=[];for(const m of list){const blob=await getBlob(m.id);if(blob){hydM.push({...m,url:URL.createObjectURL(blob)});}};if(hydM.length)setEditorMusic(hydM);}
    edMediaHydRef.current=true;
  }catch(e){edMediaHydRef.current=true;}})();},[]);
  /* save editor media metadata to localStorage */
  useEffect(()=>{if(!edMediaHydRef.current)return;try{localStorage.setItem(STORAGE_KEY_EDVIDS,JSON.stringify(editorVideos.map(v=>({id:v.id,name:v.name,duration:v.duration}))));localStorage.setItem(STORAGE_KEY_EDMUSIC,JSON.stringify(editorMusic.map(m=>({id:m.id,name:m.name,duration:m.duration}))));}catch(e){}},[editorVideos,editorMusic]);
  useEffect(()=>{try{localStorage.setItem("aua_clipFeedback",JSON.stringify(clipFeedback));}catch(e){}},[clipFeedback]);


  const allState=useCallback(()=>({v:JSON.parse(JSON.stringify(tracks)),t:JSON.parse(JSON.stringify(tagTrack)),a:JSON.parse(JSON.stringify(audioTracks))}),[tracks,tagTrack,audioTracks]);
  const pushHist=useCallback(()=>setHistory(h=>[...h.slice(-40),allState()]),[allState]);

  /* ═══ RESOLVED TAGS: compute timeline positions from source-anchored tags ═══ */
  const resolvedTags=React.useMemo(()=>{
    const allClips=[];tracks.forEach(t=>t.clips.forEach(c=>allClips.push(c)));
    const result=[];
    /* Group tags by clipId, then compute timeline positions */
    const tagsByClip={};
    tagTrack.clips.forEach(tg=>{
      if(tg.clipId){
        if(!tagsByClip[tg.clipId])tagsByClip[tg.clipId]=[];
        tagsByClip[tg.clipId].push(tg);
      }else{
        /* Legacy tag without clipId — use trackStart directly */
        result.push({...tg,_tlStart:tg.trackStart});
      }
    });
    Object.keys(tagsByClip).forEach(cid=>{
      const clip=allClips.find(c=>c.id===cid);
      if(!clip)return;/* orphaned tag — clip deleted */
      const tags=tagsByClip[cid].filter(t=>t.sourceTime>=clip.clipStart&&t.sourceTime<clip.clipEnd).sort((a,b)=>a.sourceTime-b.sourceTime);
      let fzAccum=0;
      tags.forEach(tg=>{
        const tlPos=clip.trackStart+(tg.sourceTime-clip.clipStart)+fzAccum;
        result.push({...tg,_tlStart:tlPos});
        fzAccum+=tg.duration;
      });
    });
    return result.sort((a,b)=>a._tlStart-b._tlStart);
  },[tracks,tagTrack]);

  const recalcAll=useCallback((vt,tt,at)=>{
    /* Rebuild resolved positions inline for accurate duration calc */
    const allC=[];vt.forEach(t=>t.clips.forEach(c=>allC.push(c)));
    const resolved=[];const byClip={};
    tt.clips.forEach(tg=>{if(tg.clipId){if(!byClip[tg.clipId])byClip[tg.clipId]=[];byClip[tg.clipId].push(tg);}else{resolved.push({...tg,_tlStart:tg.trackStart});}});
    Object.keys(byClip).forEach(cid=>{const cl=allC.find(c=>c.id===cid);if(!cl)return;const tags=byClip[cid].filter(t=>t.sourceTime>=cl.clipStart&&t.sourceTime<cl.clipEnd).sort((a,b)=>a.sourceTime-b.sourceTime);let fz=0;tags.forEach(tg=>{resolved.push({...tg,_tlStart:cl.trackStart+(tg.sourceTime-cl.clipStart)+fz});fz+=tg.duration;});});
    let mx=120;
    vt.forEach(t=>t.clips.forEach(c=>{const rawD=c.clipEnd-c.clipStart;let fz=0;resolved.forEach(tg=>{if(tg._tlStart>=c.trackStart&&tg._tlStart<c.trackStart+rawD+fz)fz+=tg.duration;});const e=c.trackStart+rawD+fz;if(e>mx)mx=e;}));
    resolved.forEach(c=>{const e=c._tlStart+c.duration;if(e>mx)mx=e;});
    at.forEach(t=>t.clips.forEach(c=>{const e=c.trackStart+(c.clipEnd-c.clipStart);if(e>mx)mx=e;}));
    setTlDur(mx+30);
  },[]);

  /* ═══ VIDEO POOL MANAGEMENT ═══
     Professional NLE technique: one pre-loaded <video> per clip on the timeline.
     Key insight: use OPACITY (not display:none) so browsers actually buffer the video.
     display:none tells the browser "this doesn't exist" and it won't download/decode.
     opacity:0 keeps the element "alive" — browser buffers it in the background.
     We also force-buffer by doing a brief muted play+pause cycle. */
  useEffect(()=>{
    const container=videoContainerRef.current;if(!container)return;
    const pool=videoPoolRef.current;
    const allClips=[];tracks.forEach(t=>t.clips.forEach(c=>allClips.push(c)));
    const currentIds=new Set(allClips.map(c=>c.id));
    /* Remove video elements for clips no longer on the timeline */
    Object.keys(pool).forEach(cid=>{
      if(!currentIds.has(cid)){
        const vel=pool[cid];if(vel.parentNode)vel.parentNode.removeChild(vel);
        try{vel.pause();vel.removeAttribute("src");vel.load();}catch(e){}
        delete pool[cid];
      }
    });
    /* Create/update video elements for every timeline clip */
    allClips.forEach(c=>{
      if(!pool[c.id]){
        const vel=document.createElement("video");
        vel.preload="auto";vel.playsInline=true;vel.muted=true;
        /* CRITICAL: Use opacity:0 NOT display:none — browser must buffer this element */
        vel.style.cssText="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain;opacity:0;z-index:0;pointer-events:none;";
        vel.src=c.url;
        /* Force-buffer: seek to clip start, play briefly muted, then pause.
           This forces the browser to actually download and decode video frames. */
        vel.addEventListener("loadeddata",function onld(){
          vel.removeEventListener("loadeddata",onld);
          vel.currentTime=c.clipStart||0;
          vel.play().then(()=>{setTimeout(()=>{vel.pause();vel.muted=false;},150);}).catch(()=>{vel.muted=false;});
        },{once:true});
        vel.load();
        container.appendChild(vel);
        pool[c.id]=vel;
      } else {
        const vel=pool[c.id];
        if(vel.getAttribute("src")!==c.url){vel.src=c.url;vel.load();}
      }
    });
  },[tracks]);

  const findActiveTag=useCallback(ph=>{for(const tg of resolvedTags){if(ph>=tg._tlStart&&ph<tg._tlStart+tg.duration)return tg;}return null;},[resolvedTags]);

  const freezeOffset=useCallback((clipStart,ph)=>{let total=0;for(const tg of resolvedTags){const tEnd=tg._tlStart+tg.duration;if(tEnd<=clipStart||tg._tlStart>=ph)continue;const s=Math.max(tg._tlStart,clipStart);const e=Math.min(tEnd,ph);if(e>s)total+=e-s;}return total;},[resolvedTags]);

  const findActiveClip=useCallback(ph=>{for(let i=tracks.length-1;i>=0;i--)for(const cl of tracks[i].clips){const rawD=cl.clipEnd-cl.clipStart;
    /* Count only tags that belong to THIS clip */
    let fz=0;for(const tg of resolvedTags){if(tg.clipId&&tg.clipId!==cl.id)continue;if(!tg.clipId){const tEnd=tg._tlStart+tg.duration;if(tEnd<=cl.trackStart||tg._tlStart>=cl.trackStart+rawD)continue;}fz+=tg.duration;}
    const effectiveD=rawD+fz;if(ph>=cl.trackStart&&ph<cl.trackStart+effectiveD)return cl;}return null;},[tracks,resolvedTags]);

  const findActiveAudio=useCallback(ph=>{for(const t of audioTracks)for(const cl of t.clips){const d=cl.clipEnd-cl.clipStart;if(ph>=cl.trackStart&&ph<cl.trackStart+d)return cl;}return null;},[audioTracks]);

  const handleEdVidUpload=async(files)=>{const vids=[];for(const f of files){const id=uid("evid");const url=URL.createObjectURL(f);const dur=await getMediaDur(url);await storeBlob(id,f);vids.push({id,name:f.name.replace(/\.[^.]+$/,""),url,duration:dur});}setEditorVideos(p=>[...p,...vids]);};
  const handleEdMusicUpload=async(files)=>{const songs=[];for(const f of files){const id=uid("mus");const url=URL.createObjectURL(f);const dur=await getAudioDur(url);await storeBlob(id,f);songs.push({id,name:f.name.replace(/\.[^.]+$/,""),url,duration:dur});}setEditorMusic(p=>[...p,...songs]);};

  /* ═══ MAIN TRACK COMPACTION (Ripple/Magnetic Mode) ═══ */
  /* When Magnet ON: V1 (main track, tracks[0]) stays gapless after every operation.
     Other tracks (V2, V3, Overlay, Audio) are NOT affected.
     During drag, compaction is deferred to mouseUp to avoid jumping. */
  const compactV1=useCallback(()=>{
    if(!magnetOn)return;
    setTracks(prev=>{
      const mt=prev[0];if(!mt||mt.clips.length===0)return prev;
      const sorted=[...mt.clips].sort((a,b)=>a.trackStart-b.trackStart);
      let pos=0;let changed=false;
      const compacted=sorted.map(c=>{const dur=c.clipEnd-c.clipStart;if(Math.abs(c.trackStart-pos)>0.001)changed=true;const nc={...c,trackStart:pos};pos+=dur;return nc;});
      if(!changed)return prev;
      const n=prev.map((t,i)=>i===0?{...t,clips:compacted}:t);
      recalcAll(n,tagTrack,audioTracks);return n;
    });
  },[magnetOn,recalcAll,tagTrack,audioTracks]);

  const addClip=useCallback((trackId,data,start,isAudio=false)=>{pushHist();
    const clip={id:uid("clip"),videoId:data.id,categoryId:data.categoryId||"",playerId:data.playerId||"editor",playerName:data.playerName||"Editor",
      name:data.name,url:data.url,trackStart:Math.max(0,start),clipStart:0,clipEnd:data.duration,isAudio:isAudio};
    setClipProps(p=>({...p,[clip.id]:{volume:100,scale:1}}));
    if(isAudio){setAudioTracks(p=>{const n=p.map(t=>t.id===trackId?{...t,clips:[...t.clips,clip].sort((a,b)=>a.trackStart-b.trackStart)}:t);recalcAll(tracks,tagTrack,n);return n;});}
    else{setTracks(p=>{const n=p.map(t=>t.id===trackId?{...t,clips:[...t.clips,clip].sort((a,b)=>a.trackStart-b.trackStart)}:t);recalcAll(n,tagTrack,audioTracks);return n;});compactV1();}
  },[pushHist,recalcAll,tracks,tagTrack,audioTracks,compactV1]);

  const addTag=useCallback((playerId,start,spotX=50,spotY=50)=>{pushHist();
    const player=players.find(p=>p.id===playerId);if(!player)return;
    const playerIdx=players.indexOf(player);
    /* Find the active video clip at 'start' (timeline time) and compute sourceTime */
    const clip=findActiveClip(start);
    if(!clip){console.warn("No video clip at playhead for tag");return;}
    const fo=freezeOffset(clip.trackStart,start);
    const sourceTime=clip.clipStart+(start-clip.trackStart-fo);
    const tag={id:uid("tag"),type:"tag",clipId:clip.id,sourceTime,playerId,playerName:player.name,playerColor:playerColor(playerIdx),trackStart:0,duration:1.5,spotX,spotY,spotScale:1.0};
    setClipProps(p=>({...p,[tag.id]:{volume:100,scale:1,spotScale:1.0}}));
    setTagTrack(p=>{const n={...p,clips:[...p.clips,tag]};recalcAll(tracks,n,audioTracks);return n;});
    setSelectedClipId(tag.id);
  },[pushHist,players,findActiveClip,freezeOffset,recalcAll,tracks,audioTracks]);

  const updateTagPos=useCallback((tagId,newX,newY)=>{
    setTagTrack(p=>({...p,clips:p.clips.map(c=>c.id===tagId?{...c,spotX:Math.max(5,Math.min(95,newX)),spotY:Math.max(5,Math.min(95,newY))}:c)}));
  },[]);

  const moveClip=useCallback((from,clipId,newStart,to)=>{pushHist();let mc=null;
    let foundInVideo=false;
    setTracks(p=>{let n=p.map(t=>{if(t.id===from){const c=t.clips.find(x=>x.id===clipId);if(c){mc={...c,trackStart:Math.max(0,newStart)};foundInVideo=true;}return{...t,clips:t.clips.filter(x=>x.id!==clipId)};}return t;});
      if(mc&&foundInVideo){const tid=to||from;n=n.map(t=>t.id===tid?{...t,clips:[...t.clips,mc].sort((a,b)=>a.trackStart-b.trackStart)}:t);}recalcAll(n,tagTrack,audioTracks);return n;});
    if(!foundInVideo){setAudioTracks(p=>{let n=p.map(t=>{if(t.id===from){const c=t.clips.find(x=>x.id===clipId);if(c)mc={...c,trackStart:Math.max(0,newStart)};return{...t,clips:t.clips.filter(x=>x.id!==clipId)};}return t;});
      if(mc){const tid=to||from;n=n.map(t=>t.id===tid?{...t,clips:[...t.clips,mc].sort((a,b)=>a.trackStart-b.trackStart)}:t);}recalcAll(tracks,tagTrack,n);return n;});}
  },[pushHist,recalcAll,tracks,tagTrack,audioTracks]);

  const updateClipEdge=useCallback((trackId,clipId,isLeft,newPos,isAudio=false,isTag=false)=>{
    if(isTag){
      /* For source-anchored tags, only adjust duration. Left edge does nothing (sourceTime is fixed). Right edge changes duration. */
      if(!isLeft){
        const resolved=resolvedTags.find(t=>t.id===clipId);if(!resolved)return;
        const newDur=Math.max(0.1,newPos-resolved._tlStart);
        setTagTrack(p=>{const n={...p,clips:p.clips.map(c=>c.id===clipId?{...c,duration:newDur}:c)};recalcAll(tracks,n,audioTracks);return n;});
      }
    }else if(isAudio){
      setAudioTracks(p=>{const n=p.map(t=>{if(t.id!==trackId)return t;return{...t,clips:t.clips.map(c=>{if(c.id!==clipId)return c;if(isLeft){const newStart=newPos;const dur=c.clipEnd-c.clipStart;const durReduction=c.trackStart-newStart;if(durReduction>=-0.1){const newClipStart=c.clipStart+durReduction;return{...c,trackStart:Math.max(0,newStart),clipStart:Math.max(0,newClipStart)};}return c;}else{const dur=c.clipEnd-c.clipStart;const newEnd=newPos;const newClipEnd=c.clipStart+(dur+(newEnd-c.trackStart-dur));return{...c,clipEnd:newClipEnd};}return c;})};});recalcAll(tracks,tagTrack,n);return n;});
    }else{
      setTracks(p=>{const n=p.map(t=>{if(t.id!==trackId)return t;return{...t,clips:t.clips.map(c=>{if(c.id!==clipId)return c;if(isLeft){const newStart=newPos;const dur=c.clipEnd-c.clipStart;const durReduction=c.trackStart-newStart;if(durReduction>=-0.1){const newClipStart=c.clipStart+durReduction;return{...c,trackStart:Math.max(0,newStart),clipStart:Math.max(0,newClipStart)};}return c;}else{const dur=c.clipEnd-c.clipStart;const newEnd=newPos;const newClipEnd=c.clipStart+(dur+(newEnd-c.trackStart-dur));return{...c,clipEnd:newClipEnd};}return c;})};});recalcAll(n,tagTrack,audioTracks);return n;});
    }
  },[recalcAll,tracks,tagTrack,audioTracks,resolvedTags]);

  const cutClip=useCallback((trackId,clipId)=>{pushHist();
    let aId=null,bId=null,splitSourceTime=null;
    const docut=trks=>trks.map(t=>{if(t.id!==trackId)return t;const c=t.clips.find(x=>x.id===clipId);if(!c)return t;
      const d=c.clipEnd-c.clipStart;const fo=freezeOffset(c.trackStart,playhead);const cut=playhead-c.trackStart-fo;if(cut<=.05||cut>=d-.05)return t;
      const a={...c,id:uid("clip"),clipEnd:c.clipStart+cut};aId=a.id;
      const b={...c,id:uid("clip"),trackStart:playhead,clipStart:c.clipStart+cut};bId=b.id;
      splitSourceTime=c.clipStart+cut;
      setClipProps(p=>({...p,[a.id]:{...(p[c.id]||{volume:100,scale:1})},[b.id]:{...(p[c.id]||{volume:100,scale:1})}}));
      return{...t,clips:t.clips.filter(x=>x.id!==clipId).concat([a,b]).sort((x,y)=>x.trackStart-y.trackStart)};});
    let found=false;tracks.forEach(t=>{if(t.clips.find(c=>c.id===clipId))found=true;});
    if(found){setTracks(p=>{const n=docut(p);recalcAll(n,tagTrack,audioTracks);return n;});compactV1();}
    else setAudioTracks(p=>{const n=docut(p);recalcAll(tracks,tagTrack,n);return n;});
    /* Reassign tags from old clipId to appropriate new clip */
    if(aId&&bId&&splitSourceTime!==null){
      setTagTrack(p=>{const newClips=p.clips.map(tg=>{if(tg.clipId!==clipId)return tg;return tg.sourceTime<splitSourceTime?{...tg,clipId:aId}:{...tg,clipId:bId};});return{...p,clips:newClips};});
    }
    setSelectedClipId(null);
  },[pushHist,playhead,tracks,tagTrack,audioTracks,recalcAll,compactV1,freezeOffset]);

  const cutTag=useCallback((tagId)=>{pushHist();
    const resolved=resolvedTags.find(t=>t.id===tagId);if(!resolved)return;
    const tlStart=resolved._tlStart;
    const cut=playhead-tlStart;if(cut<=.05||cut>=resolved.duration-.05)return;
    setTagTrack(p=>{const c=p.clips.find(x=>x.id===tagId);if(!c)return p;
      const a={...c,id:uid("tag"),duration:cut};const b={...c,id:uid("tag"),sourceTime:c.sourceTime,duration:c.duration-cut};
      setClipProps(pr=>({...pr,[a.id]:{...(pr[c.id]||{volume:100,scale:1,spotScale:1.0})},[b.id]:{...(pr[c.id]||{volume:100,scale:1,spotScale:1.0})}}));
      const n={...p,clips:p.clips.filter(x=>x.id!==tagId).concat([a,b])};recalcAll(tracks,n,audioTracks);return n;});
    setSelectedClipId(null);
  },[pushHist,playhead,tracks,audioTracks,recalcAll,resolvedTags]);

  const delClip=useCallback(()=>{if(!selectedClipId)return;pushHist();
    setTracks(p=>{const n=p.map(t=>({...t,clips:t.clips.filter(c=>c.id!==selectedClipId)}));recalcAll(n,tagTrack,audioTracks);return n;});
    setAudioTracks(p=>{const n=p.map(t=>({...t,clips:t.clips.filter(c=>c.id!==selectedClipId)}));recalcAll(tracks,tagTrack,n);return n;});
    /* Remove tag if it's the selected item, OR remove all tags anchored to this clip */
    setTagTrack(p=>{const n={...p,clips:p.clips.filter(c=>c.id!==selectedClipId&&c.clipId!==selectedClipId)};recalcAll(tracks,n,audioTracks);return n;});
    compactV1();
    setSelectedClipId(null);
  },[selectedClipId,pushHist,recalcAll,tracks,tagTrack,audioTracks,compactV1]);

  const closeGaps=useCallback(()=>{pushHist();
    const closeTrackGaps=clips=>{const sorted=[...clips].sort((a,b)=>a.trackStart-b.trackStart);let pos=0;return sorted.map(c=>{const dur=c.clipEnd-c.clipStart;const newC={...c,trackStart:pos};pos+=dur;return newC;});};
    setTracks(p=>{const n=p.map(t=>({...t,clips:closeTrackGaps(t.clips)}));recalcAll(n,tagTrack,audioTracks);return n;});
    setAudioTracks(p=>{const n=p.map(t=>({...t,clips:closeTrackGaps(t.clips)}));recalcAll(tracks,tagTrack,n);return n;});
  },[pushHist,recalcAll,tracks,tagTrack,audioTracks]);

  const undo=useCallback(()=>{if(!history.length)return;const prev=history[history.length-1];setTracks(prev.v);setTagTrack(prev.t);setAudioTracks(prev.a);setHistory(h=>h.slice(0,-1));recalcAll(prev.v,prev.t,prev.a);},[history,recalcAll]);
  const addTrack=()=>setTracks(p=>[...p,{id:uid("trk"),name:`V${p.length+1}`,clips:[]}]);
  const addAudioTrack=()=>setAudioTracks(p=>[...p,{id:uid("atrk"),name:`A${p.length+1}`,clips:[]}]);

  /* ═══ SNAP HELPER ═══ */
  const SNAP_THRESH=8;/* pixels */
  const snapToEdges=useCallback((timeSec,clipId,clipDur)=>{
    if(!snapOn){setSnapLine(null);return timeSec;}
    const edges=[];
    /* playhead */
    edges.push(playhead);
    /* collect all clip edges except the one being moved */
    [...tracks,...audioTracks].forEach(t=>t.clips.forEach(c=>{if(c.id===clipId)return;const d=c.clipEnd-c.clipStart;edges.push(c.trackStart);edges.push(c.trackStart+d);}));
    resolvedTags.forEach(c=>{if(c.id===clipId)return;edges.push(c._tlStart);edges.push(c._tlStart+c.duration);});
    const threshSec=SNAP_THRESH/zoom;
    let best=timeSec;let bestDist=Infinity;let snapEdge=null;
    /* snap leading edge (start) */
    for(const e of edges){const d=Math.abs(timeSec-e);if(d<threshSec&&d<bestDist){bestDist=d;best=e;snapEdge=e;}}
    /* snap trailing edge (end) if we know clip duration */
    if(clipDur>0){const endT=timeSec+clipDur;for(const e of edges){const d=Math.abs(endT-e);if(d<threshSec&&d<bestDist){bestDist=d;best=e-clipDur;snapEdge=e;}}}
    if(snapEdge!==null){setSnapLine(snapEdge);clearTimeout(snapLineTimer.current);snapLineTimer.current=setTimeout(()=>setSnapLine(null),400);}
    else{setSnapLine(null);}
    return Math.max(0,best);
  },[snapOn,playhead,tracks,audioTracks,resolvedTags,zoom]);

  /* magnetPush removed — replaced by compactV1 ripple mode above */

  /* ═══ ZOOM TO FIT ═══ */
  const zoomToFit=useCallback(()=>{
    let contentEnd=0;
    tracks.forEach(t=>t.clips.forEach(c=>{const e=c.trackStart+(c.clipEnd-c.clipStart);if(e>contentEnd)contentEnd=e;}));
    resolvedTags.forEach(c=>{const e=c._tlStart+c.duration;if(e>contentEnd)contentEnd=e;});
    audioTracks.forEach(t=>t.clips.forEach(c=>{const e=c.trackStart+(c.clipEnd-c.clipStart);if(e>contentEnd)contentEnd=e;}));
    if(contentEnd<=0)return;
    const el=tlScrollRef.current;if(!el)return;
    const availW=el.clientWidth-20;/* small padding */
    const newZoom=Math.max(2,Math.min(200,availW/contentEnd));
    setZoom(newZoom);
    if(el)el.scrollLeft=0;
  },[tracks,resolvedTags,audioTracks]);

  /* ═══ VIDEO EXPORT ═══
     KEY DESIGN: Video elements for drawImage are NEVER connected to AudioContext.
     createMediaElementSource() can cause browsers to stop decoding video frames.
     Instead we use SEPARATE audio elements for sound capture.

     Architecture:
     - videoEls{} = per-clip <video> for canvas drawImage (pure video, no AudioContext)
     - audioEls{} = per-clip <audio> connected to AudioContext for sound capture
     - Both load from same blob URLs (downloaded from Firebase Storage)
     - Frame-by-frame stepping with seek+wait for guaranteed frame accuracy */
  const exportVideo=useCallback(async()=>{
    setIsPlaying(false);if(animRef.current)cancelAnimationFrame(animRef.current);
    setExporting(true);setExportProgress(0);exportCancelRef.current=false;

    /* Master try/catch — ensures UI is ALWAYS restored even if export throws */
    let exportContainer=null;
    try{

    /* ── PRE-COMPUTE A FLAT RENDER LIST ──
       Instead of using findActiveClip/freezeOffset during export (which causes timing
       bugs at cut boundaries), we pre-compute the exact render instruction for every
       frame. This eliminates pauses/freezes at cuts. */
    const allClips=[];tracks.forEach(t=>t.clips.forEach(c=>allClips.push(c)));

    /* Build a flat segment list: [{clipId, tlStart, tlEnd, srcStart, srcEnd, isTag, tag}] */
    const segments=[];
    allClips.forEach(cl=>{
      const rawD=cl.clipEnd-cl.clipStart;
      /* Find tags that belong to this clip */
      const clipTags=resolvedTags.filter(tg=>tg.clipId===cl.id&&tg.sourceTime>=cl.clipStart&&tg.sourceTime<cl.clipEnd).sort((a,b)=>a.sourceTime-b.sourceTime);
      let tlPos=cl.trackStart;let srcPos=cl.clipStart;
      clipTags.forEach(tg=>{
        const tagSrcT=tg.sourceTime;
        /* Video segment before this tag */
        if(tagSrcT>srcPos){
          segments.push({clipId:cl.id,url:cl.url,tlStart:tlPos,tlEnd:tlPos+(tagSrcT-srcPos),srcStart:srcPos,srcEnd:tagSrcT,isTag:false});
          tlPos+=tagSrcT-srcPos;
        }
        /* Tag segment (frozen frame) */
        segments.push({clipId:cl.id,url:cl.url,tlStart:tlPos,tlEnd:tlPos+tg.duration,srcStart:tagSrcT,srcEnd:tagSrcT,isTag:true,tag:tg});
        tlPos+=tg.duration;
        srcPos=tagSrcT;
      });
      /* Remaining video after last tag */
      if(srcPos<cl.clipEnd){
        segments.push({clipId:cl.id,url:cl.url,tlStart:tlPos,tlEnd:tlPos+(cl.clipEnd-srcPos),srcStart:srcPos,srcEnd:cl.clipEnd,isTag:false});
      }
    });
    /* Also add tags not bound to a clip */
    resolvedTags.filter(tg=>!tg.clipId).forEach(tg=>{
      const parentClip=allClips.find(c=>tg._tlStart>=c.trackStart);
      segments.push({clipId:parentClip?.id,url:parentClip?.url,tlStart:tg._tlStart,tlEnd:tg._tlStart+tg.duration,srcStart:tg.sourceTime||0,srcEnd:tg.sourceTime||0,isTag:true,tag:tg});
    });
    segments.sort((a,b)=>a.tlStart-b.tlStart);

    /* Compute content end */
    let cEnd=0;
    segments.forEach(s=>{if(s.tlEnd>cEnd)cEnd=s.tlEnd;});
    audioTracks.forEach(t=>t.clips.forEach(c=>{const e=c.trackStart+(c.clipEnd-c.clipStart);if(e>cEnd)cEnd=e;}));
    if(cEnd<=0){setExporting(false);return;}

    const fps=30;const totalFrames=Math.ceil(cEnd*fps);
    const hideCss="position:fixed;left:0;bottom:0;width:1px;height:1px;pointer-events:none;z-index:-1;";

    /* Lookup: given a frame time, find the segment */
    const findSeg=(t)=>{for(let i=segments.length-1;i>=0;i--){const s=segments[i];if(t>=s.tlStart&&t<s.tlEnd)return s;}return null;};

    /* ── Step 1: Download ALL media URLs as local blobs ── */
    setExportFmt("Downloading media...");
    const blobUrlMap={};const allUrls=new Set();
    tracks.forEach(t=>t.clips.forEach(c=>{if(c.url)allUrls.add(c.url);}));
    audioTracks.forEach(t=>t.clips.forEach(c=>{if(c.url)allUrls.add(c.url);}));
    let dlCount=0,dlFailed=0;const dlTotal=allUrls.size;
    for(const u of allUrls){
      dlCount++;setExportFmt(`Downloading ${dlCount}/${dlTotal}...`);
      if(u.startsWith("blob:")){blobUrlMap[u]=u;continue;}
      try{const resp=await fetch(u);if(!resp.ok)throw new Error("HTTP "+resp.status);const blob=await resp.blob();blobUrlMap[u]=URL.createObjectURL(blob);
      }catch(fetchErr){
        const blobUrl=await new Promise(r=>{const xhr=new XMLHttpRequest();xhr.open("GET",u,true);xhr.responseType="blob";xhr.onload=()=>r(xhr.status===200?URL.createObjectURL(xhr.response):null);xhr.onerror=()=>r(null);xhr.send();});
        if(blobUrl){blobUrlMap[u]=blobUrl;}else{dlFailed++;blobUrlMap[u]=u;}
      }
    }
    if(dlFailed>0){alert("⚠️ Could not download "+dlFailed+" video(s). CORS may not be configured. Export may produce black video.");}

    /* ── Step 2: Create video elements for export drawing ──
       Elements are small, nearly transparent, and don't block the UI.
       pointer-events:none ensures they can't be clicked.
       They sit at the bottom-left corner, invisible to the user but
       "visible" enough for the browser to decode frames. */
    setExportFmt("Preparing video...");
    exportContainer=document.createElement("div");
    exportContainer.style.cssText="position:fixed;bottom:0;left:0;width:320px;height:180px;z-index:-1;overflow:hidden;pointer-events:none;opacity:0.01;";
    document.body.appendChild(exportContainer);
    const videoEls={};
    for(let i=0;i<allClips.length;i++){
      const c=allClips[i];setExportFmt(`Loading video ${i+1}/${allClips.length}...`);
      const vel=document.createElement("video");
      vel.playsInline=true;vel.preload="auto";vel.muted=true;
      vel.style.cssText="width:320px;height:180px;position:absolute;top:0;left:0;";
      vel.src=blobUrlMap[c.url]||c.url;
      exportContainer.appendChild(vel);
      await new Promise(resolve=>{
        let done2=false;const finish=()=>{if(!done2){done2=true;videoEls[c.id]=vel;resolve();}};
        vel.addEventListener("canplaythrough",finish,{once:true});
        vel.addEventListener("loadeddata",()=>{vel.currentTime=c.clipStart||0;vel.play().then(()=>{setTimeout(()=>{vel.pause();finish();},200);}).catch(()=>finish());},{once:true});
        vel.load();setTimeout(finish,15000);
      });
    }

    /* ── Step 3: Verify drawImage (CORS check) ──
       Fill canvas with bright red, then drawImage. If getImageData still shows red,
       drawImage didn't work (CORS/tainted). If pixels changed at all, it's working
       — even if the video frame is very dark (nighttime footage). */
    const testCvs=document.createElement("canvas");testCvs.width=16;testCvs.height=16;const testCx=testCvs.getContext("2d");
    const firstVel=videoEls[allClips[0]?.id];let drawWorks=false;
    if(firstVel&&firstVel.readyState>=2){
      testCx.fillStyle="#ff0000";testCx.fillRect(0,0,16,16);
      try{
        testCx.drawImage(firstVel,0,0,16,16);
        const px=testCx.getImageData(0,0,16,16).data;
        /* If ANY pixel is NOT pure red (#ff0000), drawImage overwrote it = working */
        for(let i=0;i<px.length;i+=4){if(px[i]!==255||px[i+1]!==0||px[i+2]!==0){drawWorks=true;break;}}
      }catch(e){/* SecurityError = tainted canvas = CORS issue */}
    }else if(firstVel){drawWorks=true;/* readyState may catch up — proceed optimistically */}
    console.log("[Export] drawImage test:",drawWorks?"PASS":"FAIL","readyState:",firstVel?.readyState,"dim:",firstVel?.videoWidth+"x"+firstVel?.videoHeight);
    if(!drawWorks){if(!confirm("⚠️ Canvas CORS test failed. Export may be black.\nThis usually means Firebase CORS is not configured.\nOK=try anyway, Cancel=abort")){
      Object.values(videoEls).forEach(v=>{try{v.pause();}catch(e){}});exportContainer.remove();
      Object.values(blobUrlMap).forEach(u=>{if(u&&u.startsWith("blob:")&&!allUrls.has(u))try{URL.revokeObjectURL(u);}catch(e){}});
      setExporting(false);return;}}

    /* ── Step 4: Audio elements (AudioContext for capture) ── */
    setExportFmt("Preparing audio...");
    const actx=new(window.AudioContext||window.webkitAudioContext)();await actx.resume();
    const aDst=actx.createMediaStreamDestination();
    const audioEls={};const audioGains={};
    allClips.forEach(c=>{try{const ael=document.createElement("audio");ael.preload="auto";ael.style.cssText=hideCss;ael.src=blobUrlMap[c.url]||c.url;document.body.appendChild(ael);ael.load();
      const src=actx.createMediaElementSource(ael);const gain=actx.createGain();gain.gain.value=0;src.connect(gain).connect(aDst);audioEls[c.id]=ael;audioGains[c.id]=gain;}catch(e){}});
    const eA=document.createElement("audio");eA.volume=1;eA.style.cssText=hideCss;document.body.appendChild(eA);
    let eASrc=null,eAGain=null;
    try{eASrc=actx.createMediaElementSource(eA);eAGain=actx.createGain();eASrc.connect(eAGain).connect(aDst);}catch(e){}

    /* ── Step 5: Canvas + MediaRecorder ── */
    const W=1920,H=1080;
    const cvs=document.createElement("canvas");cvs.width=W;cvs.height=H;
    const cx=cvs.getContext("2d");cx.imageSmoothingEnabled=true;cx.imageSmoothingQuality="high";
    const cStream=cvs.captureStream(fps);
    const mStream=new MediaStream([...cStream.getVideoTracks(),...aDst.stream.getAudioTracks()]);
    /* Prefer MP4 (H.264/AAC) for YouTube compatibility, fall back to WebM.
       Chrome 120+ supports MP4 in MediaRecorder. Older browsers get WebM. */
    const mimes=["video/mp4;codecs=avc1.42E01E,mp4a.40.2","video/mp4;codecs=avc1,mp4a.40.2","video/mp4","video/webm;codecs=vp9,opus","video/webm;codecs=vp8,opus","video/webm"];
    let mime=mimes.find(m=>MediaRecorder.isTypeSupported(m))||"video/webm";
    const isMP4=mime.startsWith("video/mp4");const ext=isMP4?"mp4":"webm";
    setExportFmt(ext.toUpperCase()+" 0%");
    const rec=new MediaRecorder(mStream,{mimeType:mime,videoBitsPerSecond:20000000,audioBitsPerSecond:320000});
    const chunks=[];rec.ondataavailable=e=>{if(e.data.size>0)chunks.push(e.data);};

    const cleanup=()=>{
      try{actx.close();}catch(e){}
      Object.values(videoEls).forEach(v=>{try{v.pause();v.removeAttribute("src");v.load();}catch(e){}});
      Object.values(audioEls).forEach(a=>{try{a.pause();a.removeAttribute("src");a.load();document.body.removeChild(a);}catch(e){}});
      try{eA.pause();eA.removeAttribute("src");eA.load();document.body.removeChild(eA);}catch(e){}
      try{exportContainer.remove();}catch(e){}
      Object.values(blobUrlMap).forEach(u=>{if(u&&u.startsWith("blob:")&&!allUrls.has(u))try{URL.revokeObjectURL(u);}catch(e){}});
    };

    /* ── Drawing helpers ── */

    /* CANONICAL TRANSFORM: one function used by both preview and export.
       Computes where the video lands on the output canvas, replicating
       CSS object-fit:contain + transform:scale exactly.
       Returns {dx, dy, dw, dh} — the destination rectangle on the canvas. */
    const computeVideoTransform=(srcW,srcH,outW,outH,scale)=>{
      const s=scale||1;
      const vidAsp=srcW/srcH,canAsp=outW/outH;
      let dw,dh;
      if(vidAsp>canAsp){dw=outW;dh=outW/vidAsp;}
      else{dh=outH;dw=outH*vidAsp;}
      /* CSS transform:scale() scales visually around center without changing layout.
         We replicate this by scaling dw/dh then re-centering. */
      dw*=s;dh*=s;
      return{dx:(outW-dw)/2,dy:(outH-dh)/2,dw,dh};
    };

    /* drawVideoFit: draws video onto canvas using the canonical transform. */
    const drawVideoFit=(vel,scale)=>{
      if(!vel||vel.readyState<2)return;
      const vw=vel.videoWidth,vh=vel.videoHeight;
      if(!vw||!vh)return;
      const t=computeVideoTransform(vw,vh,W,H,scale);
      try{cx.drawImage(vel,t.dx,t.dy,t.dw,t.dh);}catch(e){}
    };

    /* drawSpotlight: overlay rendering that matches preview EXACTLY.

       KEY INSIGHT: In the preview, spotX/spotY are percentages of the
       PREVIEW CONTAINER (a 16:9 box), NOT percentages of the video frame.
       The spotlight overlay is positioned with CSS left:${sx}%, top:${sy}%
       relative to the container — same coordinate space as the canvas.

       The preview container IS 16:9 (same as the export canvas 1920×1080).
       So spotX% of container width = spotX% of 1920 in export. This is correct.

       The preview spotlight circle radius is 80px * spotScale at a ~720px wide
       preview container. We scale this to 1920px export width proportionally. */
    const drawSpotlight=(tag)=>{
      const tp=clipProps[tag.id]||{};
      const ss=tp.spotScale||tag.spotScale||1;
      /* Convert percentage position to canvas pixels (same space as preview CSS %) */
      const sx=(tag.spotX||50)/100*W;
      const sy=(tag.spotY||50)/100*H;
      /* Preview container is maxWidth:720px. 80px radius at 720px wide.
         Export is 1920px wide. Scale factor = 1920/720 = 2.667 */
      const previewToExport=W/720;
      const r=Math.round(80*ss*previewToExport);
      cx.save();
      /* Vignette mask */
      cx.beginPath();cx.rect(0,0,W,H);cx.arc(sx,sy,r,0,Math.PI*2,true);
      cx.fillStyle="rgba(0,0,0,0.55)";cx.fill("evenodd");
      /* Circle border */
      cx.beginPath();cx.arc(sx,sy,r,0,Math.PI*2);
      cx.strokeStyle="#22c55e";cx.lineWidth=Math.round(3*previewToExport);
      cx.shadowColor="rgba(34,197,94,0.4)";cx.shadowBlur=Math.round(20*previewToExport);
      cx.stroke();cx.shadowBlur=0;
      /* Player name label — positioned below circle, same as preview CSS */
      const fontSize=Math.round(13*previewToExport);
      cx.font=`bold ${fontSize}px Inter,sans-serif`;cx.textAlign="center";
      const txt=tag.playerName.toUpperCase();
      const tw=cx.measureText(txt).width;
      const labelY=Math.min(sy+r+Math.round(12*previewToExport)+fontSize,H-20);
      const padX=Math.round(16*previewToExport),padY=Math.round(4*previewToExport);
      cx.fillStyle="rgba(0,0,0,0.8)";
      cx.fillRect(sx-tw/2-padX,labelY-fontSize-padY,tw+padX*2,fontSize+padY*2);
      cx.strokeStyle="rgba(34,197,94,0.33)";cx.lineWidth=Math.round(1*previewToExport);
      cx.strokeRect(sx-tw/2-padX,labelY-fontSize-padY,tw+padX*2,fontSize+padY*2);
      cx.fillStyle="#fff";cx.fillText(txt,sx,labelY);
      /* SPOTLIGHT badge — top center, same as preview */
      const badgeFontSz=Math.round(10*previewToExport);
      const badgePadX=Math.round(14*previewToExport),badgePadY=Math.round(3*previewToExport);
      cx.font=`bold ${badgeFontSz}px Inter,sans-serif`;
      const badgeTw=cx.measureText("SPOTLIGHT").width;
      const badgeY=Math.round(8*previewToExport);
      cx.fillStyle="#22c55e";
      cx.fillRect(W/2-badgeTw/2-badgePadX,badgeY,badgeTw+badgePadX*2,badgeFontSz+badgePadY*2);
      cx.fillStyle="#000";cx.fillText("SPOTLIGHT",W/2,badgeY+badgeFontSz+badgePadY*0.5);
      cx.restore();
    };

    /* ── Step 6: Real-time export loop ──
       Uses pre-computed segment list for frame-accurate timing.
       No findActiveClip/freezeOffset during rendering = no timing bugs at cuts. */
    await new Promise(resolve=>{
      rec.onstop=()=>{
        const blob=new Blob(chunks,{type:mime.split(";")[0]});
        if(!exportCancelRef.current){
          const u=URL.createObjectURL(blob);const a=document.createElement("a");
          a.href=u;a.download=`AthletesUSA_Highlight_${new Date().toISOString().slice(0,10)}.${ext}`;
          document.body.appendChild(a);a.click();document.body.removeChild(a);
          setTimeout(()=>URL.revokeObjectURL(u),2000);
        }
        cleanup();setExporting(false);resolve();
      };
      rec.start(1000);

      let ph=0,lt=performance.now();
      let curSegIdx=-1,curVidEl=null,curAudEl=null;
      let pAudioClipId=null;

      const step=(now)=>{
        if(exportCancelRef.current){rec.stop();return;}
        const dt=Math.min((now-lt)/1000,0.1);lt=now;ph+=dt;
        if(ph>=cEnd){rec.stop();return;}
        setExportProgress(ph/cEnd);
        if(Math.round(ph*fps)%fps===0)setExportFmt(`${ext.toUpperCase()} ${Math.round(ph/cEnd*100)}%`);

        cx.fillStyle="#000";cx.fillRect(0,0,W,H);

        /* Find current segment from pre-computed list */
        const seg=findSeg(ph);

        if(seg&&seg.isTag){
          /* TAG SEGMENT: frozen frame + spotlight overlay */
          const vel=videoEls[seg.clipId];
          if(vel){
            /* Seek to exact source time (tag is a freeze frame) */
            const targetT=Math.max(0,seg.srcStart);
            if(Math.abs(vel.currentTime-targetT)>0.05)vel.currentTime=targetT;
            if(!vel.paused)vel.pause();
            drawVideoFit(vel,1);
          }
          if(seg.tag)drawSpotlight(seg.tag);
          /* Mute all clip audio during tags */
          Object.values(audioGains).forEach(g=>g.gain.value=0);
          if(curAudEl){curAudEl.pause();curAudEl=null;}

        }else if(seg){
          /* VIDEO SEGMENT: play video from srcStart→srcEnd mapped to tlStart→tlEnd */
          const pr=clipProps[seg.clipId]||{volume:100,scale:1};
          const progress=(ph-seg.tlStart)/(seg.tlEnd-seg.tlStart);
          const srcTime=seg.srcStart+progress*(seg.srcEnd-seg.srcStart);
          const vel=videoEls[seg.clipId];

          if(vel){
            /* On segment switch: seek to exact source position and start playing */
            const segIdx=segments.indexOf(seg);
            if(segIdx!==curSegIdx){
              curSegIdx=segIdx;
              /* Pause all other videos */
              Object.entries(videoEls).forEach(([cid,v])=>{if(cid!==seg.clipId&&!v.paused)v.pause();});
              vel.currentTime=Math.max(0,srcTime);
              vel.play().catch(()=>{});
              /* Switch audio */
              Object.values(audioGains).forEach(g=>g.gain.value=0);
              if(curAudEl)curAudEl.pause();
              curAudEl=audioEls[seg.clipId]||null;
              if(curAudEl){curAudEl.currentTime=Math.max(0,srcTime);curAudEl.play().catch(()=>{});}
            }else{
              /* Same segment — keep playing, periodic sync */
              if(vel.paused)vel.play().catch(()=>{});
              if(Math.abs(vel.currentTime-srcTime)>0.3)vel.currentTime=Math.max(0,srcTime);
            }
            if(audioGains[seg.clipId])audioGains[seg.clipId].gain.value=pr.volume/100;
            drawVideoFit(vel,pr.scale||1);
          }

          /* Audio track (A1/A2 music) */
          const au=findActiveAudio(ph);
          if(au){const ap=clipProps[au.id]||{volume:100};
            if(pAudioClipId!==au.id){pAudioClipId=au.id;eA.src=blobUrlMap[au.url]||au.url;
              const afo=freezeOffset(au.trackStart,ph);const at2=au.clipStart+(ph-au.trackStart-afo);
              eA.currentTime=Math.max(0,at2);eA.play().catch(()=>{});}
            if(eAGain)eAGain.gain.value=ap.volume/100;}
          else{if(pAudioClipId){eA.pause();pAudioClipId=null;}if(eAGain)eAGain.gain.value=0;}

        }else{
          /* GAP — no content */
          curSegIdx=-1;
          Object.values(audioGains).forEach(g=>g.gain.value=0);
          if(curAudEl){curAudEl.pause();curAudEl=null;}
          Object.values(videoEls).forEach(v=>{if(!v.paused)v.pause();});
          if(eAGain)eAGain.gain.value=0;if(pAudioClipId){eA.pause();pAudioClipId=null;}
        }
        requestAnimationFrame(step);
      };
      requestAnimationFrame(step);
    });

    }catch(exportErr){
      /* Safety net: always clean up and restore UI */
      console.error("[Export] Error:",exportErr);
      try{if(exportContainer)exportContainer.remove();}catch(e){}
      setExporting(false);setExportProgress(0);
      alert("Export failed: "+exportErr.message);
    }
  },[tracks,tagTrack,audioTracks,resolvedTags,findActiveClip,findActiveTag,findActiveAudio,freezeOffset,clipProps]);

  const togglePlay=useCallback(()=>{if(isPlaying){setIsPlaying(false);if(animRef.current)cancelAnimationFrame(animRef.current);}else{setIsPlaying(true);lastTRef.current=performance.now();}},[isPlaying]);

  /* Compute actual content end (not tlDur which includes padding) */
  const contentEnd=React.useMemo(()=>{
    let mx=0;
    tracks.forEach(t=>t.clips.forEach(c=>{const rawD=c.clipEnd-c.clipStart;
      let fz=0;resolvedTags.forEach(tg=>{if(tg.clipId&&tg.clipId!==c.id)return;if(!tg.clipId){if(tg._tlStart<c.trackStart||tg._tlStart>=c.trackStart+rawD)return;}fz+=tg.duration;});
      const e=c.trackStart+rawD+fz;if(e>mx)mx=e;}));
    resolvedTags.forEach(c=>{const e=c._tlStart+c.duration;if(e>mx)mx=e;});
    audioTracks.forEach(t=>t.clips.forEach(c=>{const e=c.trackStart+(c.clipEnd-c.clipStart);if(e>mx)mx=e;}));
    return mx;
  },[tracks,resolvedTags,audioTracks]);

  /* ═══ PLAYBACK ANIMATION LOOP ═══ */
  useEffect(()=>{if(!isPlaying){
    /* When playback stops, pause ALL pool videos + audio immediately */
    const pool=videoPoolRef.current;Object.values(pool).forEach(vel=>{if(!vel.paused)vel.pause();});
    const a=audioRef.current;if(a&&!a.paused)a.pause();
    return;
  }const anim=now=>{const dt=(now-lastTRef.current)/1000;lastTRef.current=now;setPlayhead(p=>{const n=p+dt;if(contentEnd>0&&n>=contentEnd){setIsPlaying(false);
    const pool=videoPoolRef.current;Object.values(pool).forEach(vel=>{vel.pause();});
    const a=audioRef.current;if(a)a.pause();
    return contentEnd;}return n;});animRef.current=requestAnimationFrame(anim);};animRef.current=requestAnimationFrame(anim);return()=>{if(animRef.current)cancelAnimationFrame(animRef.current);};},[isPlaying,contentEnd]);

  /* ═══ VIDEO POOL SYNC — the core NLE playback engine ═══
     Uses opacity + z-index layering (NOT display:none) so every video stays buffered.
     Active clip: opacity:1, z-index:2 (visible on top)
     Inactive clips: opacity:0, z-index:0 (invisible but still buffered by browser)
     Result: instant clip switching with zero black frames. */
  useEffect(()=>{
    const pool=videoPoolRef.current;
    const clip=findActiveClip(playhead);
    const tag=findActiveTag(playhead);

    /* Helper: bring one video to front, push all others back */
    const showOnly=(clipId,seekTo,vol,shouldPlay)=>{
      Object.entries(pool).forEach(([cid,vel])=>{
        if(cid===clipId){
          vel.style.opacity="1";vel.style.zIndex="2";vel.style.pointerEvents="auto";
          vel.volume=vol;
          if(Math.abs(vel.currentTime-seekTo)>0.15)vel.currentTime=Math.max(0,seekTo);
          if(shouldPlay&&vel.paused)vel.play().catch(()=>{});
          if(!shouldPlay&&!vel.paused)vel.pause();
          activeVideoRef.current=vel;
        } else {
          vel.style.opacity="0";vel.style.zIndex="0";vel.style.pointerEvents="none";
          if(!vel.paused)vel.pause();
        }
      });
    };

    /* Helper: push all videos back (none visible) */
    const hideAll=()=>{
      Object.values(pool).forEach(vel=>{vel.style.opacity="0";vel.style.zIndex="0";vel.style.pointerEvents="none";if(!vel.paused)vel.pause();});
      activeVideoRef.current=null;
    };

    /* No clip and no tag at playhead — hide everything */
    if(!clip&&!tag){hideAll();prevClipRef.current=null;prevTagRef.current=null;return;}

    /* TAG (freeze/spotlight) — show parent clip's video, paused at sourceTime */
    if(tag){
      if(prevTagRef.current===tag.id)return;
      prevTagRef.current=tag.id;
      let clip2=null;
      if(tag.clipId){tracks.forEach(t=>t.clips.forEach(c=>{if(c.id===tag.clipId)clip2=c;}));}
      if(!clip2)clip2=findActiveClip(tag._tlStart);
      if(clip2){
        prevClipRef.current=clip2.id;
        showOnly(clip2.id,Math.max(0,tag.sourceTime||clip2.clipStart),0,false);
      } else {hideAll();prevClipRef.current=null;}
      return;
    }

    /* NORMAL CLIP playback */
    const wasInTag=prevTagRef.current!==null;prevTagRef.current=null;
    const pr=clipProps[clip.id]||{volume:100,scale:1};
    const fo=freezeOffset(clip.trackStart,playhead);
    const vt=clip.clipStart+(playhead-clip.trackStart-fo);
    const vol=pr.volume/100;

    if(prevClipRef.current!==clip.id){
      /* ══ CLIP SWITCH ══ Just swap z-index layers — video is pre-buffered! */
      prevClipRef.current=clip.id;
      showOnly(clip.id,vt,vol,isPlaying);
    } else if(wasInTag){
      showOnly(clip.id,vt,vol,isPlaying);
    } else if(!isPlaying){
      /* Scrubbing — seek to correct position */
      const vel=pool[clip.id];
      if(vel){
        vel.style.opacity="1";vel.style.zIndex="2";vel.style.pointerEvents="auto";
        vel.volume=vol;
        if(!vel.paused)vel.pause();
        if(Math.abs(vel.currentTime-vt)>0.1)vel.currentTime=Math.max(0,vt);
        activeVideoRef.current=vel;
        Object.entries(pool).forEach(([cid,v2])=>{if(cid!==clip.id){v2.style.opacity="0";v2.style.zIndex="0";v2.style.pointerEvents="none";if(!v2.paused)v2.pause();}});
      }
    } else {
      /* Same clip, playing — just ensure it's playing and correct volume */
      const vel=pool[clip.id];
      if(vel){vel.volume=vol;if(vel.paused)vel.play().catch(()=>{});}
    }
  },[playhead,isPlaying,findActiveClip,findActiveTag,freezeOffset,clipProps,tracks]);

  const prevAudioTagRef=useRef(null);
  useEffect(()=>{const tag=findActiveTag(playhead);const clip=findActiveAudio(playhead);const a=audioRef.current;
    if(tag){if(a)a.pause();prevAudioTagRef.current=tag.id;return;}
    const wasAudioTag=prevAudioTagRef.current!==null;prevAudioTagRef.current=null;
    if(!clip){if(a){a.pause();a.removeAttribute("src");a.load();}prevAudioRef.current=null;return;}
    const pr=clipProps[clip.id]||{volume:100,scale:1};const fo=freezeOffset(clip.trackStart,playhead);const at=clip.clipStart+(playhead-clip.trackStart-fo);
    if(a){a.volume=pr.volume/100;if(prevAudioRef.current!==clip.id){prevAudioRef.current=clip.id;a.src=clip.url;a.currentTime=Math.max(0,at);if(isPlaying)a.play().catch(()=>{});}
    else if(wasAudioTag){a.currentTime=Math.max(0,at);if(isPlaying)a.play().catch(()=>{});}
    else if(!isPlaying){a.pause();if(Math.abs(a.currentTime-at)>.1)a.currentTime=Math.max(0,at);}
    else{if(a.paused)a.play().catch(()=>{});}}},[playhead,isPlaying,findActiveAudio,findActiveTag,freezeOffset,clipProps]);

  useEffect(()=>{const h=e=>{if(exporting)return;if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA")return;
    if(e.key===" "){e.preventDefault();togglePlay();}
    else if((e.metaKey||e.ctrlKey)&&(e.key==="b"||e.key==="B")){e.preventDefault();
      for(const tg of resolvedTags){if(playhead>tg._tlStart&&playhead<tg._tlStart+tg.duration){cutTag(tg.id);return;}}
      const allTrks=[...tracks,...audioTracks];for(const t of allTrks)for(const c of t.clips){const d=c.clipEnd-c.clipStart;if(playhead>c.trackStart&&playhead<c.trackStart+d){cutClip(t.id,c.id);return;}}
    }
    else if(e.key==="v"||e.key==="V")setTool("select");
    else if((e.metaKey||e.ctrlKey)&&e.key==="z"){e.preventDefault();undo();}
    else if(e.key==="Delete"||e.key==="Backspace"){e.preventDefault();delClip();}
    else if(e.key==="ArrowLeft"){e.preventDefault();setPlayhead(p=>Math.max(0,p-1));}
    else if(e.key==="ArrowRight"){e.preventDefault();setPlayhead(p=>Math.min(contentEnd||tlDur,p+1));}
    else if(e.key==="n"||e.key==="N")setSnapOn(p=>!p);
    else if(e.key==="m"||e.key==="M")setMagnetOn(p=>!p);
    else if(e.key==="s"||e.key==="S"){
      const ap=activePlayerId&&players.find(p=>p.id===activePlayerId);
      const target=ap||players.length===1&&players[0];
      if(target){e.preventDefault();addTag(target.id,playhead);}
    }
    else if(e.key==="Escape"){setSpotlightMode(null);setShowTagMenu(false);}};
    window.addEventListener("keydown",h);return()=>window.removeEventListener("keydown",h);},[togglePlay,undo,delClip,cutClip,cutTag,tlDur,contentEnd,tracks,resolvedTags,audioTracks,playhead,exporting,activePlayerId,players,addTag]);

  useEffect(()=>{if(!isPlaying||!tlScrollRef.current)return;const el=tlScrollRef.current;const px=playhead*zoom;if(px>el.scrollLeft+el.clientWidth-80)el.scrollLeft=px-el.clientWidth/2;},[playhead,isPlaying,zoom]);

  const activeClip=findActiveClip(playhead);const activeTag=findActiveTag(playhead);const actProps=activeClip?(clipProps[activeClip.id]||{volume:100,scale:1}):null;
  const selClip=(()=>{for(const t of [...tracks,...audioTracks]){const c=t.clips.find(x=>x.id===selectedClipId);if(c)return c;}for(const c of tagTrack.clips){if(c.id===selectedClipId)return c;}return null;})();
  const selProps=selClip?(clipProps[selClip.id]||{volume:100,scale:1}):null;

  const sidebar=(
  <div style={{width:260,minWidth:260,background:C.mantle,borderRight:`1px solid ${C.s0}`,display:"flex",flexDirection:"column",overflow:"hidden"}}>
    <div style={{padding:"10px 14px",borderBottom:`1px solid ${C.s0}`,display:"flex",alignItems:"center",gap:6}}>
      <FolderIcon size={13} color={C.sub}/><span style={{color:C.sub,fontSize:11,fontWeight:700,textTransform:"uppercase",letterSpacing:1}}>Players</span>
      <span style={{color:C.overlay,fontSize:10,marginLeft:"auto"}}>{players.length}</span>
      <button onClick={onRefreshPlayers} style={{...ib,color:C.blue,marginLeft:4}} title="Refresh from cloud"><RefreshIcon size={12}/></button>
    </div>
    <div style={{flex:1,overflow:"auto",padding:"4px 0"}}>
      {players.length===0&&<div style={{padding:"16px 14px",color:C.overlay,fontSize:11,textAlign:"center"}}>No players yet. Players upload clips from the Athlete Portal.</div>}
      {players.map((pl,pi)=>{
        const pColor=playerColor(pi);const pExp=expandedPlayers[pl.id]!==false;
        const totalVids=pl.categories.reduce((a,c)=>a+c.videos.length,0);
        return(
        <div key={pl.id}>
          <div onClick={()=>{setExpandedPlayers(p=>({...p,[pl.id]:!pExp}));if(!pExp)setActivePlayerId(pl.id);}}
            style={{display:"flex",alignItems:"center",gap:6,padding:"7px 14px",cursor:"pointer",userSelect:"none"}}
            onMouseEnter={e=>e.currentTarget.style.background=C.s0+"66"} onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
            {pExp?<ChevronDownIcon size={12} color={C.sub}/>:<ChevronRightIcon size={12} color={C.sub}/>}
            {pl.profilePicUrl?<img src={pl.profilePicUrl} style={{width:18,height:18,borderRadius:"50%",objectFit:"cover",border:`1px solid ${pColor}`,flexShrink:0}}/>
            :pExp?<FolderOpenIcon size={14} color={pColor}/>:<FolderIcon size={14} color={pColor}/>}
            <span style={{color:C.text,fontSize:12,fontWeight:700,flex:1}}>{pl.name}</span>
            {pl.shirtNumber&&<span style={{color:pColor,fontSize:8,fontWeight:700,marginRight:2}}>#{pl.shirtNumber}</span>}
            <span style={{color:C.overlay,fontSize:9,background:C.s0,padding:"2px 6px",borderRadius:4}}>{totalVids}</span>
            <button onClick={e=>{e.stopPropagation();downloadPlayerZip(pl,prog=>{}).then(r=>{if(r&&r.missing>0)alert(r.downloaded+"/"+r.total+" clips downloaded. "+r.missing+" missing — see MISSING_FILES.txt");}).catch(err=>alert("Zip failed: "+err.message));}}
              style={{...ib,color:C.green,padding:2,marginLeft:2,opacity:0.7}} title="Download all clips as ZIP"
              onMouseEnter={e=>e.currentTarget.style.opacity="1"} onMouseLeave={e=>e.currentTarget.style.opacity="0.7"}>
              <DownloadIcon size={12}/>
            </button>
          </div>
          {pExp&&<div style={{paddingBottom:4}}>
            <div style={{padding:"2px 14px 4px 36px",color:C.overlay,fontSize:9}}>Class {pl.recruitingClass}{pl.shirtNumber?" · #"+pl.shirtNumber:""}{pl.size?" · "+pl.size:""}{pl.positions&&pl.positions.length>0?" · "+pl.positions.join(", "):""}</div>
            <div style={{display:"flex",gap:4,padding:"3px 14px 4px 36px",flexWrap:"wrap",alignItems:"center"}}>
              <span style={{color:C.overlay,fontSize:8,fontWeight:600,marginRight:2}}>PICS:</span>
              {pl.profilePicUrl?<button onClick={e=>{e.stopPropagation();downloadImage(pl.profilePicUrl,`${pl.name.replace(/\s+/g,"_")}_profile.jpg`);}} style={{...ib,color:C.blue,fontSize:8,gap:3,display:"flex",alignItems:"center",background:C.blue+"12",borderRadius:4,padding:"2px 6px"}} title="Download profile pic"><DownloadIcon size={9}/><span style={{fontSize:8,fontWeight:600}}>Profile</span></button>
              :<span style={{color:C.overlay,fontSize:8,fontStyle:"italic",padding:"2px 6px"}}>No profile pic</span>}
              {pl.playingPicUrl?<button onClick={e=>{e.stopPropagation();downloadImage(pl.playingPicUrl,`${pl.name.replace(/\s+/g,"_")}_action.jpg`);}} style={{...ib,color:C.coral,fontSize:8,gap:3,display:"flex",alignItems:"center",background:C.coral+"12",borderRadius:4,padding:"2px 6px"}} title="Download action pic"><DownloadIcon size={9}/><span style={{fontSize:8,fontWeight:600}}>Action</span></button>
              :<span style={{color:C.overlay,fontSize:8,fontStyle:"italic",padding:"2px 6px"}}>No action pic</span>}
            </div>
            {pl.categories.map((cat,ci)=>{
              const cColor=CAT_COLORS[ci%CAT_COLORS.length];const cKey=`${pl.id}-${cat.id}`;const cExp=expandedCats[cKey]!==false;
              return(
              <div key={cat.id}>
                <div onClick={()=>setExpandedCats(p=>({...p,[cKey]:!cExp}))}
                  style={{display:"flex",alignItems:"center",gap:5,padding:"4px 14px 4px 36px",cursor:"pointer",userSelect:"none",fontSize:11}}
                  onMouseEnter={e=>e.currentTarget.style.background=C.s0+"44"} onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
                  {cExp?<ChevronDownIcon size={10} color={C.overlay}/>:<ChevronRightIcon size={10} color={C.overlay}/>}
                  <div style={{width:6,height:6,borderRadius:2,background:cColor,flexShrink:0}}/>
                  <span style={{color:C.sub,fontWeight:600,flex:1}}>{cat.name}</span>
                  <span style={{color:C.overlay,fontSize:9}}>{cat.videos.length}</span>
                </div>
                {cExp&&cat.videos.map(v=>(
                  <div key={v.id} draggable onDragStart={e=>{e.dataTransfer.setData("application/json",JSON.stringify({...v,categoryId:cat.id,playerId:pl.id,playerName:pl.name,duration:v.duration,type:"video"}));e.dataTransfer.effectAllowed="copy";}} onDoubleClick={()=>{const lastV1=tracks[0].clips.length>0?tracks[0].clips[tracks[0].clips.length-1]:null;const start=lastV1?lastV1.trackStart+(lastV1.clipEnd-lastV1.clipStart):0;addClip(tracks[0].id,{...v,categoryId:cat.id,playerId:pl.id,playerName:pl.name,duration:v.duration},start,false);}}
                    style={{display:"flex",alignItems:"center",gap:5,padding:"3px 14px 3px 52px",cursor:"grab",borderRadius:4,margin:"0 4px",fontSize:10}}
                    onMouseEnter={e=>e.currentTarget.style.background=C.s0} onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
                    <FilmIcon size={10} color={cColor}/>
                    <span style={{color:C.sub,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1}}>{v.name}</span>
                    <span style={{color:C.overlay,fontSize:8,flexShrink:0}}>{fmtTime(v.duration)}</span>
                  </div>
                ))}
                {cExp&&cat.videos.length===0&&<div style={{padding:"2px 14px 4px 52px",color:C.overlay,fontSize:9,fontStyle:"italic"}}>No clips</div>}
              </div>);
            })}
          </div>}
        </div>);
      })}
    </div>
    <div style={{borderTop:`1px solid ${C.s0}`}}>
      <div onClick={()=>setShowEditorSection(p=>!p)} style={{display:"flex",alignItems:"center",gap:6,padding:"10px 14px",cursor:"pointer",userSelect:"none"}}
        onMouseEnter={e=>e.currentTarget.style.background=C.s0+"44"} onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
        {showEditorSection?<ChevronDownIcon size={12} color={C.sub}/>:<ChevronRightIcon size={12} color={C.sub}/>}
        <ClapperIcon size={13} color={C.coral}/>
        <span style={{color:C.sub,fontSize:11,fontWeight:700,textTransform:"uppercase",letterSpacing:1}}>Editor Media</span>
      </div>
      {showEditorSection&&<div style={{padding:"0 14px 12px",display:"flex",flexDirection:"column",gap:6}}>
        <input ref={edVidRef} type="file" accept="video/*" multiple onChange={e=>{if(e.target.files.length)handleEdVidUpload(Array.from(e.target.files));}} style={{display:"none"}}/>
        <input ref={edMusicRef} type="file" accept="audio/*" multiple onChange={e=>{if(e.target.files.length)handleEdMusicUpload(Array.from(e.target.files));}} style={{display:"none"}}/>
        <div style={{display:"flex",gap:4}}>
          <button onClick={()=>edVidRef.current?.click()} style={{flex:1,display:"flex",alignItems:"center",justifyContent:"center",gap:4,background:C.s0,border:`1px solid ${C.s1}`,borderRadius:6,padding:"6px 8px",color:C.sub,cursor:"pointer",fontSize:10,fontWeight:600}}>
            <UploadIcon size={10}/> Video
          </button>
          <button onClick={()=>edMusicRef.current?.click()} style={{flex:1,display:"flex",alignItems:"center",justifyContent:"center",gap:4,background:C.s0,border:`1px solid ${C.s1}`,borderRadius:6,padding:"6px 8px",color:C.sub,cursor:"pointer",fontSize:10,fontWeight:600}}>
            <MusicIcon size={10}/> Music
          </button>
        </div>
        {editorVideos.map(v=>(
          <div key={v.id} draggable onDragStart={e=>{e.dataTransfer.setData("application/json",JSON.stringify({...v,playerId:"editor",playerName:"Editor",duration:v.duration,type:"video"}));e.dataTransfer.effectAllowed="copy";}} onDoubleClick={()=>{const lastV1=tracks[0].clips.length>0?tracks[0].clips[tracks[0].clips.length-1]:null;const start=lastV1?lastV1.trackStart+(lastV1.clipEnd-lastV1.clipStart):0;addClip(tracks[0].id,{...v,playerId:"editor",playerName:"Editor",duration:v.duration},start,false);}}
            style={{display:"flex",alignItems:"center",gap:5,padding:"3px 4px",cursor:"grab",borderRadius:4,fontSize:10}}
            onMouseEnter={e=>e.currentTarget.style.background=C.s0} onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
            <FilmIcon size={10} color={C.peach}/>
            <span style={{color:C.sub,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1}}>{v.name}</span>
            <span style={{color:C.overlay,fontSize:8}}>{fmtTime(v.duration)}</span>
          </div>
        ))}
        {editorMusic.map(m=>(
          <div key={m.id} draggable onDragStart={e=>{e.dataTransfer.setData("application/json",JSON.stringify({...m,playerId:"editor",playerName:"Editor",duration:m.duration,type:"audio"}));e.dataTransfer.effectAllowed="copy";}} onDoubleClick={()=>{const lastA1=audioTracks[0].clips.length>0?audioTracks[0].clips[audioTracks[0].clips.length-1]:null;const start=lastA1?lastA1.trackStart+(lastA1.clipEnd-lastA1.clipStart):0;addClip(audioTracks[0].id,{...m,playerId:"editor",playerName:"Editor",duration:m.duration},start,true);}}
            style={{display:"flex",alignItems:"center",gap:5,padding:"3px 4px",cursor:"grab",borderRadius:4,fontSize:10}}
            onMouseEnter={e=>e.currentTarget.style.background=C.s0} onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
            <MusicIcon size={10} color={C.lavender}/>
            <span style={{color:C.sub,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",flex:1}}>{m.name}</span>
            <span style={{color:C.overlay,fontSize:8}}>{fmtTime(m.duration)}</span>
          </div>
        ))}
      </div>}
    </div>
  </div>);

  const preview=(
  <div style={{flex:1,display:"flex",flexDirection:"column",background:C.crust,overflow:"hidden"}}>
    <audio ref={audioRef} preload="auto"/>
    <div style={{flex:1,display:"flex",alignItems:"center",justifyContent:"center",minHeight:0,padding:8}}>
      <div ref={previewRef} onClick={e=>{if(spotlightMode){const r=e.currentTarget.getBoundingClientRect();const x=((e.clientX-r.left)/r.width*100).toFixed(1);const y=((e.clientY-r.top)/r.height*100).toFixed(1);addTag(spotlightMode,playhead,+x,+y);setSpotlightMode(null);}}} style={{position:"relative",width:"100%",maxWidth:720,aspectRatio:"16/9",background:"#000",borderRadius:4,overflow:"hidden",border:"1px solid #222",cursor:spotlightMode?"crosshair":"default"}}>
        {/* Video pool container — one pre-loaded <video> per clip, managed via DOM */}
        <div ref={videoContainerRef} style={{position:"absolute",inset:0,width:"100%",height:"100%",transform:actProps?`scale(${actProps.scale})`:undefined}}/>
        {activeTag&&(()=>{const tProps=clipProps[activeTag.id]||{spotScale:1.0};const ss=tProps.spotScale||activeTag.spotScale||1.0;const sx=activeTag.spotX||50;const sy=activeTag.spotY||50;const rad=Math.round(80*ss);const diam=rad*2;
          const handleSpotDrag=e=>{e.preventDefault();e.stopPropagation();const container=previewRef.current;if(!container)return;const rect=container.getBoundingClientRect();const tagId=activeTag.id;
            const onMove=ev=>{const nx=((ev.clientX-rect.left)/rect.width*100);const ny=((ev.clientY-rect.top)/rect.height*100);updateTagPos(tagId,nx,ny);};
            const onUp=()=>{document.removeEventListener("mousemove",onMove);document.removeEventListener("mouseup",onUp);};
            document.addEventListener("mousemove",onMove);document.addEventListener("mouseup",onUp);};
          return(
        <div style={{position:"absolute",inset:0,pointerEvents:"none"}}>
          <div style={{position:"absolute",inset:0,background:`radial-gradient(circle ${rad}px at ${sx}% ${sy}%, transparent ${rad-10}px, rgba(0,0,0,0.55) ${rad+2}px)`}}/>
          <div onMouseDown={handleSpotDrag} style={{position:"absolute",left:`${sx}%`,top:`${sy}%`,transform:"translate(-50%,-50%)",width:diam,height:diam,borderRadius:"50%",border:`3px solid ${C.green}`,boxShadow:`0 0 20px ${C.green}44, 0 0 40px ${C.green}22`,cursor:"grab",pointerEvents:"auto"}}/>
          <div style={{position:"absolute",left:`${sx}%`,top:`calc(${sy}% + ${rad+12}px)`,transform:"translateX(-50%)",textAlign:"center",whiteSpace:"nowrap"}}>
            <div style={{background:"rgba(0,0,0,0.8)",padding:"4px 16px",borderRadius:4,display:"inline-block",border:`1px solid ${C.green}55`}}>
              <span style={{color:"#fff",fontSize:13,fontWeight:700,letterSpacing:1}}>{activeTag.playerName.toUpperCase()}</span>
            </div>
          </div>
          <div style={{position:"absolute",top:8,left:"50%",transform:"translateX(-50%)",background:C.green,padding:"3px 14px",borderRadius:4}}>
            <span style={{color:"#000",fontSize:10,fontWeight:700,letterSpacing:1}}>SPOTLIGHT</span>
          </div>
        </div>);})()}
        {!activeClip&&!activeTag&&<div style={{position:"absolute",inset:0,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",color:C.overlay,fontSize:12,gap:4}}>
          <MaximizeIcon size={20} color={C.s2}/>
          <span>{tracks.every(t=>t.clips.length===0)?"Drag clips to the timeline":"No clip at playhead"}</span>
          <span style={{fontSize:9,color:C.s2}}>YouTube 1920×1080 (16:9)</span>
        </div>}
        {showGuide&&<div style={{position:"absolute",inset:0,pointerEvents:"none"}}>
          <div style={{position:"absolute",left:"10%",top:"10%",right:"10%",bottom:"10%",border:"2px dashed #00bcd4",opacity:0.7}}/>
          <div style={{position:"absolute",left:"5%",top:"5%",right:"5%",bottom:"5%",border:"2px dashed #ffd700",opacity:0.5}}/>
          <div style={{position:"absolute",left:"50%",top:"50%",transform:"translate(-50%, -50%)",width:2,height:2,background:"#00bcd4"}}/>
          <div style={{position:"absolute",left:"50%",top:"50%",transform:"translate(-50%, -50%)",width:30,height:2,background:"#00bcd4",opacity:0.3}}/>
          <div style={{position:"absolute",left:"50%",top:"50%",transform:"translate(-50%, -50%)",width:2,height:30,background:"#00bcd4",opacity:0.3}}/>
          <span style={{position:"absolute",left:12,top:12,color:"#00bcd4",fontSize:10,fontWeight:600,opacity:0.7}}>16:9</span>
          <span style={{position:"absolute",right:12,top:12,color:"#ffd700",fontSize:10,fontWeight:600,opacity:0.5}}>1920×1080</span>
        </div>}
        {spotlightMode&&<div style={{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(0,0,0,0.3)",cursor:"crosshair",pointerEvents:"none"}}>
          <div style={{background:C.green,padding:"8px 20px",borderRadius:8}}>
            <span style={{color:"#000",fontSize:13,fontWeight:700}}>Click to place spotlight</span>
          </div>
        </div>}
        <div style={{position:"absolute",bottom:6,right:8,background:"rgba(0,0,0,0.6)",padding:"2px 6px",borderRadius:3,fontSize:8,color:C.overlay}}>1920×1080</div>
      </div>
    </div>
    <div style={{display:"flex",alignItems:"center",gap:6,padding:"6px 12px",borderTop:`1px solid ${C.s0}`,background:C.mantle,flexWrap:"wrap"}}>
      <button onClick={()=>setPlayhead(0)} style={{...ib,color:C.sub}}><SkipBackIcon size={15}/></button>
      <button onClick={togglePlay} style={{...ib,color:C.text,background:C.s0,borderRadius:6,padding:"5px 9px"}}>{isPlaying?<PauseIcon size={15}/>:<PlayIcon size={15}/>}</button>
      <span style={{color:C.text,fontSize:12,fontFamily:"monospace",minWidth:85}}>{fmtTime(playhead)}</span>
      <div style={{width:1,height:18,background:C.s0}}/>
      <button onClick={()=>setTool("select")} style={{...tb,background:tool==="select"?C.blue+"33":"transparent",color:tool==="select"?C.blue:C.sub,border:tool==="select"?`1px solid ${C.blue}55`:"1px solid transparent",fontSize:11}}><MousePointerIcon size={13}/> Select</button>
      <button onClick={()=>setTool("blade")} style={{...tb,background:tool==="blade"?C.peach+"33":"transparent",color:tool==="blade"?C.peach:C.sub,border:tool==="blade"?`1px solid ${C.peach}55`:"1px solid transparent",fontSize:11}}><ScissorsIcon size={13}/> Blade</button>
      <div style={{width:1,height:18,background:C.s0}}/>
      <button onClick={undo} disabled={!history.length} style={{...ib,color:history.length?C.sub:C.s1}} title="Undo (Cmd+Z)"><Undo2Icon size={14}/></button>
      <button onClick={delClip} disabled={!selectedClipId} style={{...ib,color:selectedClipId?C.red:C.s1}} title="Delete"><Trash2Icon size={14}/></button>
      <button onClick={()=>setShowGuide(p=>!p)} style={{...ib,color:showGuide?C.yellow:C.sub}} title="Toggle guide"><MaximizeIcon size={14}/></button>
      <div style={{width:1,height:18,background:C.s0}}/>
      <button onClick={()=>{const wasOff=!magnetOn;setMagnetOn(p=>!p);if(wasOff){setTracks(prev=>{const mt=prev[0];if(!mt||mt.clips.length===0)return prev;const sorted=[...mt.clips].sort((a,b)=>a.trackStart-b.trackStart);let pos=0;let changed=false;const compacted=sorted.map(c=>{const dur=c.clipEnd-c.clipStart;if(Math.abs(c.trackStart-pos)>0.001)changed=true;const nc={...c,trackStart:pos};pos+=dur;return nc;});if(!changed)return prev;const n=prev.map((t,i)=>i===0?{...t,clips:compacted}:t);recalcAll(n,tagTrack,audioTracks);return n;});}}} style={{...tb,background:magnetOn?C.coral+"33":"transparent",color:magnetOn?C.coral:C.s2,border:magnetOn?`1px solid ${C.coral}55`:"1px solid transparent",fontSize:10,padding:"3px 8px",borderRadius:5,gap:3}} title={magnetOn?"Magnet ON — main track stays compact (no gaps)":"Magnet OFF — free positioning"}>
        <MagnetIcon size={12}/><span style={{fontSize:9}}>Magnet</span>
      </button>
      <button onClick={()=>setSnapOn(p=>!p)} style={{...tb,background:snapOn?C.blue+"33":"transparent",color:snapOn?C.blue:C.s2,border:snapOn?`1px solid ${C.blue}55`:"1px solid transparent",fontSize:10,padding:"3px 8px",borderRadius:5,gap:3}} title={snapOn?"Snap ON — clips snap to edges & playhead":"Snap OFF"}>
        <svg width={12} height={12} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M4 12h4m8 0h4"/><rect x="8" y="6" width="8" height="12" rx="1" fill={snapOn?"currentColor":"none"} fillOpacity="0.2"/></svg>
        <span style={{fontSize:9}}>Snap</span>
      </button>
      <button onClick={zoomToFit} style={{...ib,color:C.sub}} title="Zoom to fit timeline"><FitIcon size={13}/></button>
      <div style={{width:1,height:18,background:C.s0}}/>
      <div style={{position:"relative"}}>
        <button onClick={()=>{
          const ap=activePlayerId&&players.find(p=>p.id===activePlayerId);
          if(ap){setSpotlightMode(ap.id);setShowTagMenu(false);}
          else if(players.length===1){setSpotlightMode(players[0].id);setShowTagMenu(false);}
          else{setShowTagMenu(p=>!p);}
        }} style={{...tb,background:showTagMenu||spotlightMode?C.green:C.green+"22",color:showTagMenu||spotlightMode?"#000":C.green,border:`1px solid ${C.green}`,borderRadius:20,padding:"4px 12px",fontSize:11,fontWeight:700,letterSpacing:0.5}}>
          &#9673; {activePlayerId&&players.find(p=>p.id===activePlayerId)?`Tag ${players.find(p=>p.id===activePlayerId).name}`:"Add Spotlight"}
        </button>
        {showTagMenu&&<div style={{position:"absolute",bottom:"100%",left:0,marginBottom:4,background:C.mantle,border:`1px solid ${C.s0}`,borderRadius:8,padding:6,minWidth:160,zIndex:50,boxShadow:"0 -4px 20px rgba(0,0,0,0.4)"}}>
          {players.length===0?<div style={{padding:"8px 12px",color:C.overlay,fontSize:11}}>No players available</div>:players.map((pl,i)=>(
            <button key={pl.id} onClick={()=>{setSpotlightMode(pl.id);setShowTagMenu(false);setActivePlayerId(pl.id);}} style={{display:"flex",alignItems:"center",gap:8,width:"100%",textAlign:"left",background:"transparent",border:"none",padding:"8px 12px",color:C.text,cursor:"pointer",fontSize:11,borderRadius:4}}
              onMouseEnter={e=>e.currentTarget.style.background=C.s0} onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
              <div style={{width:8,height:8,borderRadius:"50%",background:playerColor(i)}}/>
              {pl.name}
            </button>
          ))}
        </div>}
      </div>
      <div style={{flex:1}}/>
      <button onClick={()=>setZoom(z=>Math.max(2,z<=15?z-2:z-15))} style={{...ib,color:C.sub}}><ZoomOutIcon size={13}/></button>
      <input type="range" min={2} max={200} step={1} value={zoom} onChange={e=>setZoom(+e.target.value)} style={{width:100,accentColor:C.blue}}/>
      <span style={{color:C.overlay,fontSize:9,minWidth:36,textAlign:"center"}}>{Math.round(zoom)}px/s</span>
      <button onClick={()=>setZoom(z=>Math.min(200,z+15))} style={{...ib,color:C.sub}}><ZoomInIcon size={13}/></button>
    </div>
    {selClip&&(
      <div style={{borderTop:`1px solid ${C.s0}`,background:C.mantle}}>
        <div style={{display:"flex",alignItems:"center",gap:10,padding:"5px 12px",fontSize:11}}>
          <span style={{color:C.sub,fontWeight:600,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:160}}>{selClip.playerName} — {selClip.name}</span>
          <div style={{width:1,height:14,background:C.s0}}/>
          {!selClip.type||selClip.type!=="tag"?(
            <>
              <Volume2Icon size={12} color={C.sub}/>
              <input type="range" min={0} max={100} step={1} value={selProps.volume} onChange={e=>setClipProps(p=>({...p,[selClip.id]:{...selProps,volume:+e.target.value}}))} style={{width:70,accentColor:C.blue}}/>
              <span style={{color:C.overlay,minWidth:28}}>{selProps.volume}%</span>
              {!selClip.isAudio&&<>
                <div style={{width:1,height:14,background:C.s0}}/>
                <MaximizeIcon size={12} color={C.sub}/>
                <span style={{color:C.sub,fontSize:10}}>Scale</span>
                <input type="range" min={50} max={300} step={5} value={Math.round(selProps.scale*100)} onChange={e=>setClipProps(p=>({...p,[selClip.id]:{...selProps,scale:+e.target.value/100}}))} style={{width:70,accentColor:C.lavender}}/>
                <span style={{color:C.overlay,minWidth:28}}>{Math.round(selProps.scale*100)}%</span>
              </>}
            </>
          ):(<>
            <EyeIcon size={12} color={C.green}/>
            <span style={{color:C.green,fontSize:10}}>Spotlight Scale</span>
            <input type="range" min={30} max={300} step={5} value={Math.round((selProps.spotScale||1)*100)} onChange={e=>setClipProps(p=>({...p,[selClip.id]:{...selProps,spotScale:+e.target.value/100}}))} style={{width:80,accentColor:C.green}}/>
            <span style={{color:C.overlay,minWidth:28}}>{Math.round((selProps.spotScale||1)*100)}%</span>
          </>)}
          <div style={{marginLeft:"auto",display:"flex",alignItems:"center",gap:6}}>
            {clipFeedback[selClip.id]&&<span style={{fontSize:8,color:C.peach||"#fab387",fontWeight:700}}>HAS FEEDBACK</span>}
            <button onClick={()=>setShowFeedbackPanel(p=>!p)} style={{display:"flex",alignItems:"center",gap:4,background:showFeedbackPanel?(C.peach||"#fab387")+"33":"transparent",border:`1px solid ${(C.peach||"#fab387")}${showFeedbackPanel?"":"44"}`,borderRadius:6,padding:"3px 10px",cursor:"pointer",color:C.peach||"#fab387",fontSize:10,fontWeight:700}}>
              <MessageSquareIcon size={11}/> Feedback
            </button>
          </div>
        </div>
        {showFeedbackPanel&&(
          <div style={{padding:"8px 12px 10px",borderTop:`1px solid ${C.s0}44`,background:C.crust}}>
            <div style={{display:"flex",flexWrap:"wrap",gap:4,marginBottom:8}}>
              {["Great clip","Good moment","Needs trim","Too long","Bad angle","Keep this","Remove","Highlight","Slow-mo worthy","Key play"].map(tag=>{
                const fb=clipFeedback[selClip.id]||{tags:[],note:""};
                const active=fb.tags&&fb.tags.includes(tag);
                return <button key={tag} onClick={()=>{
                  setClipFeedback(p=>{const prev=p[selClip.id]||{tags:[],note:""};const newTags=prev.tags.includes(tag)?prev.tags.filter(t=>t!==tag):[...prev.tags,tag];return{...p,[selClip.id]:{...prev,tags:newTags}};});
                }} style={{padding:"3px 10px",borderRadius:12,fontSize:9,fontWeight:600,cursor:"pointer",border:active?`1px solid ${C.peach||"#fab387"}`:`1px solid ${C.s1}`,background:active?(C.peach||"#fab387")+"22":"transparent",color:active?(C.peach||"#fab387"):C.sub,transition:"all 0.15s"}}>{tag}</button>;
              })}
            </div>
            <div style={{display:"flex",gap:8}}>
              <input value={(clipFeedback[selClip.id]||{}).note||""} onChange={e=>setClipFeedback(p=>{const prev=p[selClip.id]||{tags:[],note:""};return{...p,[selClip.id]:{...prev,note:e.target.value}};})}
                placeholder="Write detailed feedback for this clip..." style={{flex:1,background:C.s0,border:`1px solid ${C.s1}`,borderRadius:6,padding:"6px 10px",color:C.text,fontSize:11,outline:"none",fontFamily:"'Inter',sans-serif"}}
                onFocus={e=>e.target.style.borderColor=C.peach||"#fab387"} onBlur={e=>e.target.style.borderColor=C.s1}/>
              {(clipFeedback[selClip.id]&&(clipFeedback[selClip.id].tags.length>0||clipFeedback[selClip.id].note))&&
                <button onClick={()=>setClipFeedback(p=>{const n={...p};delete n[selClip.id];return n;})} style={{background:C.red+"22",border:`1px solid ${C.red}44`,borderRadius:6,padding:"4px 10px",cursor:"pointer",color:C.red,fontSize:9,fontWeight:700,whiteSpace:"nowrap"}}>Clear</button>}
            </div>
            {clipFeedback[selClip.id]&&clipFeedback[selClip.id].tags.length>0&&(
              <div style={{marginTop:6,display:"flex",flexWrap:"wrap",gap:3}}>
                {clipFeedback[selClip.id].tags.map(t=><span key={t} style={{background:(C.peach||"#fab387")+"22",color:C.peach||"#fab387",fontSize:8,fontWeight:700,padding:"2px 8px",borderRadius:10}}>{t}</span>)}
              </div>
            )}
          </div>
        )}
      </div>
    )}
  </div>);

  const handleTlClick=e=>{const scrollEl=tlScrollRef.current;if(!scrollEl)return;const r=scrollEl.getBoundingClientRect();const scrollL=scrollEl.scrollLeft;setPlayhead(Math.max(0,(e.clientX-r.left+scrollL)/zoom));setSelectedClipId(null);};
  const handlePlayheadDrag=e=>{e.stopPropagation();e.preventDefault();const scrollEl=tlScrollRef.current;if(!scrollEl)return;
    const parent=scrollEl.querySelector("[data-tl-area]")||scrollEl;
    const move=ev=>{const r=parent.getBoundingClientRect();const scrollL=scrollEl.scrollLeft;const x=ev.clientX-r.left+scrollL;setPlayhead(Math.max(0,x/zoom));};
    const up=()=>{document.removeEventListener("mousemove",move);document.removeEventListener("mouseup",up);};
    document.addEventListener("mousemove",move);document.addEventListener("mouseup",up);};
  const handleClipMD=(e,trkId,clip,allTrkIds)=>{e.stopPropagation();if(tool==="blade"){cutClip(trkId,clip.id);return;}
    setSelectedClipId(clip.id);const sx=e.clientX,sts=clip.trackStart,tidx=allTrkIds.indexOf(trkId),sy=e.clientY;let curTid=trkId;const th=clip.isAudio?AUDIO_TRACK_H:TRACK_H;const cDur=clip.clipEnd-clip.clipStart;
    const onM=ev=>{const dx=ev.clientX-sx;let ns=Math.max(0,sts+dx/zoom);ns=snapToEdges(ns,clip.id,cDur);const dy=ev.clientY-sy,off=Math.round(dy/th),ni=Math.min(allTrkIds.length-1,Math.max(0,tidx+off)),ntid=allTrkIds[ni];moveClip(curTid,clip.id,ns,ntid);curTid=ntid;};
    const onU=()=>{document.removeEventListener("mousemove",onM);document.removeEventListener("mouseup",onU);compactV1();};document.addEventListener("mousemove",onM);document.addEventListener("mouseup",onU);};
  const handleClipMDTag=(e,clip,isTag)=>{e.stopPropagation();
    if(tool==="blade"){cutTag(clip.id);return;}
    setSelectedClipId(clip.id);
    /* Tags are source-anchored — no drag movement, only select */};
  const handleEdgeMouseDown=(e,trkId,clipId,isLeft,isAudio,isTag)=>{e.stopPropagation();pushHist();const sx=e.clientX;const onM=ev=>{const dx=ev.clientX-sx;const newPos=Math.max(0,(isLeft?Math.max(0,findActiveClip(playhead)?.trackStart||0):playhead)*zoom+dx)/zoom;updateClipEdge(trkId,clipId,isLeft,newPos,isAudio,isTag);};const onU=()=>{document.removeEventListener("mousemove",onM);document.removeEventListener("mouseup",onU);if(!isAudio&&!isTag)compactV1();};document.addEventListener("mousemove",onM);document.addEventListener("mouseup",onU);};
  const handleDrop=(e,trkId,isAudio=false)=>{e.preventDefault();e.currentTarget.style.background="transparent";
    try{const d=JSON.parse(e.dataTransfer.getData("application/json"));const r=e.currentTarget.getBoundingClientRect();const x=e.clientX-r.left+(tlScrollRef.current?.scrollLeft||0);
      let dropT=Math.max(0,x/zoom);dropT=snapToEdges(dropT,null,d.duration||0);
      const dropIsAudio=isAudio||d.type==="audio";addClip(trkId,d,dropT,dropIsAudio);
    }catch(err){}};

  const totalW=tlDur*zoom;const tickI=zoom>=80?1:zoom>=40?5:10;const ticks=[];for(let i=0;i<=tlDur;i+=tickI)ticks.push(i);const subI=tickI/5;
  const allVideoTrkIds=tracks.map(t=>t.id);const allAudioTrkIds=audioTracks.map(t=>t.id);const allTrkIds=[...allVideoTrkIds,...allAudioTrkIds];
  const totalTracksH=tracks.length*TRACK_H+TAG_TRACK_H+audioTracks.length*AUDIO_TRACK_H;

  const timeline=(
  <div style={{background:C.crust,borderTop:`1px solid ${C.s0}`,display:"flex",flexDirection:"column",minHeight:0,flex:1}}>
    <div style={{display:"flex",flex:1,minHeight:0}}>
      <div style={{width:48,minWidth:48,background:C.mantle,borderRight:`1px solid ${C.s0}`,flexShrink:0}}>
        <div style={{height:RULER_H,borderBottom:`1px solid ${C.s0}`}}/>
        {tracks.map(t=><div key={t.id} style={{height:TRACK_H,display:"flex",alignItems:"center",justifyContent:"center",borderBottom:`1px solid ${C.s0}22`,color:C.overlay,fontSize:10,fontWeight:600}}>{t.name}</div>)}
        <button onClick={addTrack} style={{width:"100%",height:24,display:"flex",alignItems:"center",justifyContent:"center",background:"transparent",border:"none",color:C.overlay,cursor:"pointer",fontSize:9}} title="Add video track"><PlusIcon size={10}/></button>
        <div style={{height:TAG_TRACK_H,display:"flex",alignItems:"center",justifyContent:"center",borderBottom:`1px solid ${C.s0}22`,color:C.green,fontSize:8,fontWeight:700,letterSpacing:0.5}}>OVERLAY</div>
        <div style={{height:1,background:C.coral+"44"}}/>
        {audioTracks.map(t=><div key={t.id} style={{height:AUDIO_TRACK_H,display:"flex",alignItems:"center",justifyContent:"center",borderBottom:`1px solid ${C.s0}22`,color:C.lavender,fontSize:10,fontWeight:600}}><MusicIcon size={10} style={{marginRight:3}}/>{t.name}</div>)}
        <button onClick={addAudioTrack} style={{width:"100%",height:24,display:"flex",alignItems:"center",justifyContent:"center",background:"transparent",border:"none",color:C.overlay,cursor:"pointer",fontSize:9}} title="Add audio track"><PlusIcon size={10}/></button>
      </div>
      <div ref={tlScrollRef} style={{flex:1,overflowX:"auto",overflowY:"auto",position:"relative"}}>
        <div data-tl-area="1" style={{width:totalW,minWidth:"100%",position:"relative"}}>
          <div onClick={handleTlClick} style={{height:RULER_H,position:"relative",borderBottom:`1px solid ${C.s1}`,cursor:"pointer",background:C.mantle,userSelect:"none"}}>
            {ticks.map(t=><div key={`t${t}`} style={{position:"absolute",left:t*zoom,top:0}}><div style={{position:"absolute",left:0,top:RULER_H-14,width:1,height:14,background:C.s2}}/><span style={{position:"absolute",left:4,top:2,color:C.sub,fontSize:9,fontFamily:"monospace",whiteSpace:"nowrap"}}>{fmtTime(t)}</span></div>)}
            {subI>=.5&&ticks.map(t=>{const s=[];for(let x=t+subI;x<t+tickI&&x<=tlDur;x+=subI)s.push(x);return s.map(x=><div key={`s${x}`} style={{position:"absolute",left:x*zoom,bottom:0,width:1,height:6,background:C.s1}}/>);})}
          </div>
          {tracks.map(trk=>(
            <div key={trk.id} onDragOver={e=>{e.preventDefault();e.currentTarget.style.background=C.s0+"44";}} onDragLeave={e=>{e.currentTarget.style.background="transparent";}} onDrop={e=>handleDrop(e,trk.id,false)} onClick={handleTlClick}
              style={{height:TRACK_H,position:"relative",borderBottom:`1px solid ${C.s0}22`,cursor:tool==="blade"?"crosshair":"default"}}>
              {trk.clips.map(clip=>{const dur=clip.clipEnd-clip.clipStart;const w=Math.max(MIN_CLIP_W,dur*zoom);
                const pi=players.findIndex(p=>p.id===clip.playerId);const pCol=pi>=0?playerColor(pi):C.peach;
                const isSel=clip.id===selectedClipId;
                const x=clip.trackStart*zoom;
                return(
                <div key={clip.id} onMouseDown={e=>handleClipMD(e,trk.id,clip,allVideoTrkIds)} onClick={e=>e.stopPropagation()}
                  style={{position:"absolute",left:x,width:w,top:3,bottom:3,
                    background:`linear-gradient(180deg,${pCol}cc 60%,${pCol}44 60%)`,borderRadius:5,cursor:tool==="blade"?"crosshair":"grab",overflow:"hidden",
                    border:isSel?`2px solid ${C.text}`:`1px solid ${pCol}44`,boxShadow:isSel?`0 0 8px ${C.blue}55`:"none",
                    display:"flex",flexDirection:"column",userSelect:"none",zIndex:isSel?5:1}}>
                  <div style={{flex:1,display:"flex",alignItems:"center",padding:"0 6px",minHeight:0}}>
                    {clipFeedback[clip.id]&&<div style={{width:6,height:6,borderRadius:"50%",background:C.peach||"#fab387",flexShrink:0,marginRight:4,boxShadow:`0 0 4px ${C.peach||"#fab387"}`}} title="Has feedback"/>}
                    <span style={{color:"#000",fontSize:10,fontWeight:700,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",textShadow:"0 0 4px rgba(255,255,255,0.3)"}}>{clip.name}</span>
                    {w>80&&<span style={{color:"#00000088",fontSize:8,marginLeft:"auto",flexShrink:0,fontFamily:"monospace"}}>{clip.playerName}</span>}
                  </div>
                  <div style={{height:22,padding:"0 2px",opacity:0.7,flexShrink:0}}>
                    <Waveform w={Math.max(4,w-4)} h={20} color={pCol} seed={clip.id.charCodeAt(4)||1}/>
                  </div>
                  <div onMouseDown={e=>handleEdgeMouseDown(e,trk.id,clip.id,true,false,false)} style={{position:"absolute",left:0,top:0,bottom:0,width:8,cursor:"col-resize",opacity:0}}/>
                  <div onMouseDown={e=>handleEdgeMouseDown(e,trk.id,clip.id,false,false,false)} style={{position:"absolute",right:0,top:0,bottom:0,width:8,cursor:"col-resize",opacity:0}}/>
                </div>);})}
            </div>
          ))}
          <div onClick={handleTlClick} style={{height:TAG_TRACK_H,position:"relative",borderBottom:`1px solid ${C.s0}22`,background:C.s0+"22",cursor:tool==="blade"?"crosshair":"default"}}>
            {resolvedTags.map(tag=>{const w=Math.max(MIN_CLIP_W,tag.duration*zoom);
              const isSel=tag.id===selectedClipId;
              const x=tag._tlStart*zoom;
              return(
              <div key={tag.id} onMouseDown={e=>handleClipMDTag(e,{...tag,trackStart:tag._tlStart},true)} onClick={e=>e.stopPropagation()}
                style={{position:"absolute",left:x,width:w,top:4,bottom:4,
                  background:C.green,borderRadius:4,cursor:tool==="blade"?"crosshair":"grab",overflow:"hidden",
                  border:isSel?`2px solid ${C.text}`:`1px solid ${C.green}88`,boxShadow:isSel?`0 0 8px ${C.green}55`:"none",
                  display:"flex",alignItems:"center",justifyContent:"center",padding:"0 6px",userSelect:"none",zIndex:isSel?5:1}}>
                <span style={{color:"#000",fontSize:9,fontWeight:700,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",textShadow:"0 0 2px rgba(255,255,255,0.3)"}}>{tag.playerName}</span>
                <div onMouseDown={e=>handleEdgeMouseDown(e,tagTrack.id,tag.id,true,false,true)} style={{position:"absolute",left:0,top:0,bottom:0,width:8,cursor:"col-resize",opacity:0}}/>
                <div onMouseDown={e=>handleEdgeMouseDown(e,tagTrack.id,tag.id,false,false,true)} style={{position:"absolute",right:0,top:0,bottom:0,width:8,cursor:"col-resize",opacity:0}}/>
              </div>);})}
          </div>
          <div style={{height:24}}/>
          <div style={{height:1,background:C.coral+"44"}}/>
          {audioTracks.map(trk=>(
            <div key={trk.id} onDragOver={e=>{e.preventDefault();e.currentTarget.style.background=C.lavender+"11";}} onDragLeave={e=>{e.currentTarget.style.background="transparent";}} onDrop={e=>handleDrop(e,trk.id,true)} onClick={handleTlClick}
              style={{height:AUDIO_TRACK_H,position:"relative",borderBottom:`1px solid ${C.s0}22`,cursor:tool==="blade"?"crosshair":"default"}}>
              {trk.clips.map(clip=>{const dur=clip.clipEnd-clip.clipStart;const w=Math.max(MIN_CLIP_W,dur*zoom);
                const isSel=clip.id===selectedClipId;
                const x=clip.trackStart*zoom;
                return(
                <div key={clip.id} onMouseDown={e=>handleClipMD(e,trk.id,clip,allAudioTrkIds)} onClick={e=>e.stopPropagation()}
                  style={{position:"absolute",left:x,width:w,top:3,bottom:3,
                    background:`linear-gradient(180deg,${C.lavender}55 40%,${C.lavender}22 40%)`,borderRadius:5,cursor:tool==="blade"?"crosshair":"grab",overflow:"hidden",
                    border:isSel?`2px solid ${C.text}`:`1px solid ${C.lavender}44`,boxShadow:isSel?`0 0 8px ${C.lavender}55`:"none",
                    display:"flex",flexDirection:"column",userSelect:"none",zIndex:isSel?5:1}}>
                  <div style={{display:"flex",alignItems:"center",padding:"2px 6px",minHeight:0}}>
                    <MusicIcon size={9} color="#000" style={{marginRight:3,flexShrink:0}}/>
                    <span style={{color:"#000",fontSize:9,fontWeight:700,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",textShadow:"0 0 4px rgba(255,255,255,0.3)"}}>{clip.name}</span>
                  </div>
                  <div style={{flex:1,padding:"0 2px",opacity:0.8,minHeight:0,overflow:"hidden"}}>
                    <Waveform w={Math.max(4,w-4)} h={24} color={C.lavender} seed={clip.id.charCodeAt(5)||7}/>
                  </div>
                  <div onMouseDown={e=>handleEdgeMouseDown(e,trk.id,clip.id,true,true,false)} style={{position:"absolute",left:0,top:0,bottom:0,width:8,cursor:"col-resize",opacity:0}}/>
                  <div onMouseDown={e=>handleEdgeMouseDown(e,trk.id,clip.id,false,true,false)} style={{position:"absolute",right:0,top:0,bottom:0,width:8,cursor:"col-resize",opacity:0}}/>
                </div>);})}
            </div>
          ))}
          <div style={{height:24}}/>
          <div onMouseDown={handlePlayheadDrag} style={{position:"absolute",left:playhead*zoom-6,top:0,width:12,height:RULER_H+totalTracksH+24+1+24,zIndex:20,cursor:"col-resize",display:"flex",justifyContent:"center"}}>
            <div style={{width:2,height:"100%",background:C.coral}}/>
            <div style={{position:"absolute",top:-2,left:0,width:12,height:12,background:C.coral,clipPath:"polygon(0 0,100% 0,50% 100%)"}}/>
          </div>
          {snapLine!==null&&<div style={{position:"absolute",left:snapLine*zoom,top:0,width:1,height:RULER_H+totalTracksH+24+1+24,background:C.yellow,zIndex:19,pointerEvents:"none",opacity:0.7}}/>}
        </div>
      </div>
    </div>
  </div>);

  return(
  <div style={{width:"100vw",height:"100vh",display:"flex",flexDirection:"column",background:C.base,fontFamily:"'Inter',sans-serif",color:C.text,overflow:"hidden"}}>
    <div style={{display:"flex",alignItems:"center",padding:"0 12px",height:44,background:C.mantle,borderBottom:`1px solid ${C.s0}`,flexShrink:0}}>
      <button onClick={onLogout} style={{...ib,color:C.sub,marginRight:8}}><ArrowLeftIcon size={16}/></button>
      <div style={{width:1,height:22,background:C.s0,marginRight:10}}/>
      <span style={{fontWeight:900,fontSize:14,color:"#fff",fontStyle:"italic",marginRight:4}}>ATHLETES</span>
      <span style={{fontWeight:900,fontSize:14,color:C.coral,fontStyle:"italic",marginRight:12}}>USA</span>
      <div style={{padding:"2px 8px",background:C.coral+"18",border:`1px solid ${C.coral}33`,borderRadius:5}}>
        <span style={{fontSize:9,fontWeight:700,color:C.coral,letterSpacing:2}}>STUDIO</span>
      </div>
      <span style={{color:C.overlay,fontSize:9,marginLeft:8,letterSpacing:1}}>1920×1080 YouTube</span>
      <div style={{flex:1}}/>
      <div style={{display:"flex",alignItems:"center",gap:10,color:C.overlay,fontSize:9}}>
        <span style={{background:C.s0,padding:"2px 6px",borderRadius:3}}>&#8984;B Split</span>
        <span style={{background:C.s0,padding:"2px 6px",borderRadius:3}}>&#8984;Z Undo</span>
        <span style={{background:C.s0,padding:"2px 6px",borderRadius:3}}>Del Delete</span>
        <span style={{background:C.s0,padding:"2px 6px",borderRadius:3}}>Space Play</span>
        <span style={{background:C.s0,padding:"2px 6px",borderRadius:3}}>N Snap</span>
        <span style={{background:C.s0,padding:"2px 6px",borderRadius:3}}>M Magnet</span>
      </div>
      <button onClick={closeGaps} style={{display:"flex",alignItems:"center",gap:5,background:"transparent",border:`1px solid ${C.s1}`,borderRadius:6,padding:"4px 10px",color:C.sub,cursor:"pointer",fontSize:10,fontWeight:600,marginLeft:8}} title="Close gaps">Close Gaps</button>
      <button onClick={exportVideo} disabled={exporting} style={{display:"flex",alignItems:"center",gap:5,background:exporting?"transparent":"linear-gradient(135deg,#22c55e,#16a34a)",border:exporting?`1px solid ${C.s1}`:"1px solid #22c55e55",borderRadius:6,padding:"4px 12px",color:exporting?C.s1:"#fff",cursor:exporting?"not-allowed":"pointer",fontSize:10,fontWeight:700,marginLeft:8,letterSpacing:0.5}} title="Export video"><DownloadIcon size={12}/> Export</button>
      <button onClick={onLogout} style={{display:"flex",alignItems:"center",gap:5,background:"transparent",border:`1px solid ${C.s1}`,borderRadius:6,padding:"4px 10px",color:C.sub,cursor:"pointer",fontSize:10,fontWeight:600,marginLeft:8}}><LogOutIcon size={12}/> Exit</button>
    </div>
    <div style={{flex:1,display:"flex",flexDirection:"column",overflow:"hidden"}}>
      <div style={{flex:"1 1 50%",display:"flex",minHeight:0}}>{sidebar}{preview}</div>
      <div style={{flex:"1 1 50%",display:"flex",flexDirection:"column",minHeight:200}}>{timeline}</div>
    </div>
    {exporting&&<div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.85)",backdropFilter:"blur(12px)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1000}}>
      <div style={{background:C.mantle,border:`1px solid ${C.s0}`,borderRadius:20,padding:"48px 56px",width:480,textAlign:"center",animation:"fadeIn 0.3s ease-out",boxShadow:"0 20px 80px rgba(0,0,0,0.6)"}}>
        <div style={{width:72,height:72,borderRadius:"50%",background:"linear-gradient(135deg,#22c55e22,#22c55e08)",border:"1px solid #22c55e33",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 20px"}}>
          <DownloadIcon size={32} color="#22c55e"/>
        </div>
        <div style={{fontSize:20,fontWeight:800,color:"#fff",marginBottom:4,fontStyle:"italic",letterSpacing:1}}>EXPORTING VIDEO</div>
        <div style={{color:C.sub,fontSize:12,marginBottom:28}}>Rendering at 1920×1080 · {exportFmt||"Best Quality"}</div>
        <div style={{background:C.s0,borderRadius:8,height:10,overflow:"hidden",marginBottom:8}}>
          <div style={{height:"100%",background:"linear-gradient(90deg,#22c55e,#16a34a)",borderRadius:8,transition:"width 0.3s ease",width:`${Math.round(exportProgress*100)}%`}}/>
        </div>
        <div style={{display:"flex",justifyContent:"space-between",marginBottom:24}}>
          <span style={{color:C.overlay,fontSize:11}}>{Math.round(exportProgress*100)}%</span>
          <span style={{color:C.overlay,fontSize:11}}>Real-time rendering</span>
        </div>
        <div style={{display:"flex",gap:4,justifyContent:"center",marginBottom:8}}>
          {[0,1,2].map(i=><div key={i} style={{width:6,height:6,borderRadius:"50%",background:"#22c55e",animation:`pulse 1.4s ease-in-out ${i*0.2}s infinite`}}/>)}
        </div>
        <div style={{color:C.overlay,fontSize:10,marginBottom:20}}>Please wait — export runs at playback speed</div>
        <button onClick={()=>{exportCancelRef.current=true;}} style={{background:"transparent",border:`1px solid ${C.s1}`,borderRadius:8,padding:"8px 28px",color:C.sub,cursor:"pointer",fontSize:12,fontWeight:600,letterSpacing:1}}>Cancel Export</button>
      </div>
    </div>}
  </div>);
}

/* ═══════════ ROOT APP ═══════════ */
const STORAGE_KEY_PLAYERS="aua_players";
const STORAGE_KEY_SESSION="aua_studio_session";
const STORAGE_KEY_EDVIDS="aua_editor_vids";
const STORAGE_KEY_EDMUSIC="aua_editor_music";
const SESSION_DURATION_MS=30*60*1000;

const loadPlayers=()=>{try{const d=localStorage.getItem(STORAGE_KEY_PLAYERS);if(d){const parsed=JSON.parse(d);return parsed.map(p=>({...p,categories:p.categories.map(c=>({...c,videos:c.videos.map(v=>({...v,url:v.url||""}))}))}));}return[];}catch(e){return[];}};
const savePlayers=players=>{try{const safe=players.map(p=>({...p,categories:p.categories.map(c=>({...c,videos:c.videos.map(v=>({id:v.id,name:v.name,duration:v.duration}))}))}));localStorage.setItem(STORAGE_KEY_PLAYERS,JSON.stringify(safe));}catch(e){}};
const isSessionValid=()=>{try{const ts=localStorage.getItem(STORAGE_KEY_SESSION);if(!ts)return false;return(Date.now()-parseInt(ts,10))<SESSION_DURATION_MS;}catch(e){return false;}};
const saveSession=()=>{try{localStorage.setItem(STORAGE_KEY_SESSION,String(Date.now()));}catch(e){}};

/* ═══ ATHLETE IDENTITY (localStorage) ═══ */
const STORAGE_KEY_ATHLETE_ID="aua_my_player_id";
const getMyPlayerId=()=>{try{return localStorage.getItem(STORAGE_KEY_ATHLETE_ID)||null;}catch(e){return null;}};
const setMyPlayerId=(id)=>{try{if(id)localStorage.setItem(STORAGE_KEY_ATHLETE_ID,id);else localStorage.removeItem(STORAGE_KEY_ATHLETE_ID);}catch(e){}};

function App(){
  /* ── Hash-based routing ──
     Routes: "" or "/" = combined landing (backward compat)
             "athlete" = athlete-only entry (NO studio access)
             "studio"  = studio entry (password-gated, CAN access athlete pages) */
  const[route,setRoute]=useState(getHashRoute);
  const[screen,setScreen]=useState("landing"); /* "landing"|"athlete"|"editor" */
  const[players,setPlayers]=useState([]);
  const[activePlayerId,setActivePlayerId]=useState(null);
  const[athleteStep,setAthleteStep]=useState("select");
  const[hydrated,setHydrated]=useState(false);
  const[cloudLoading,setCloudLoading]=useState(true);
  const[studioAuth,setStudioAuth]=useState(isSessionValid()); /* editor authenticated? */
  const[isEditorMode,setIsEditorMode]=useState(false); /* true when entering from studio route */

  /* Listen for hash changes */
  useEffect(()=>{
    const onHash=()=>{const r=getHashRoute();setRoute(r);};
    window.addEventListener("hashchange",onHash);
    return()=>window.removeEventListener("hashchange",onHash);
  },[]);

  /* Load players from Firestore on mount */
  useEffect(()=>{(async()=>{try{
    const cloud=await loadPlayersFromCloud();
    if(cloud.length>0){const hp=await hydratePlayerVideos(cloud);setPlayers(hp);setHydrated(true);setCloudLoading(false);return;}
    const local=loadPlayers();
    if(local.length>0){const hp=await hydratePlayerVideos(local);setPlayers(hp);setHydrated(true);setCloudLoading(false);return;}
    setHydrated(true);setCloudLoading(false);
  }catch(e){console.warn("Init load error:",e);
    try{const local=loadPlayers();const hp=await hydratePlayerVideos(local);setPlayers(hp);}catch(e2){}
    setHydrated(true);setCloudLoading(false);
  }})();},[]);

  useEffect(()=>{if(hydrated)savePlayers(players);},[players,hydrated]);

  const activePlayer=players.find(p=>p.id===activePlayerId)||null;

  const handleCreateProfile=data=>{
    const newPlayer={id:uid("pl"),name:data.name,recruitingClass:data.recruitingClass,size:data.size,dob:data.dob,
      shirtNumber:data.shirtNumber||"",uniformDesc:data.uniformDesc||"",positions:data.positions||[],profilePicUrl:data.profilePicUrl||"",playingPicUrl:data.playingPicUrl||"",
      categories:DEFAULT_CATS.map(n=>({id:uid("cat"),name:n,videos:[]}))};
    setPlayers(p=>[...p,newPlayer]);setActivePlayerId(newPlayer.id);setAthleteStep("portal");
    /* Save this player ID so the athlete auto-logs in next time */
    if(!isEditorMode)setMyPlayerId(newPlayer.id);
    savePlayerToCloud(newPlayer);
  };
  const handleDeletePlayer=async(playerId)=>{
    const pl=players.find(p=>p.id===playerId);
    if(pl){for(const cat of pl.categories)for(const v of cat.videos){deleteBlob(v.id).catch(()=>{});deleteVideoFromCloud(v.id).catch(()=>{});}}
    deletePlayerFromCloud(playerId).catch(()=>{});
    setPlayers(p=>p.filter(pl=>pl.id!==playerId));
    if(activePlayerId===playerId){setActivePlayerId(null);setAthleteStep("select");}
  };
  const handleUpdatePlayer=updated=>{setPlayers(p=>p.map(pl=>pl.id===updated.id?updated:pl));};

  /* ── Navigation helpers ── */
  const goToLanding=()=>{setScreen("landing");setAthleteStep("select");setActivePlayerId(null);};
  const enterAthlete=()=>{
    setIsEditorMode(false);
    /* Auto-login: if athlete has a stored player ID and that player exists, go straight to portal */
    const myId=getMyPlayerId();
    if(myId){
      const myPlayer=players.find(p=>p.id===myId);
      if(myPlayer){setActivePlayerId(myId);setScreen("athlete");setAthleteStep("portal");return;}
      /* Player ID stored but player not found (deleted by editor?) — clear it */
      setMyPlayerId(null);
    }
    setScreen("athlete");setAthleteStep("select");
  };
  const enterAthleteAsEditor=()=>{setIsEditorMode(true);setScreen("athlete");setAthleteStep("select");};
  const enterStudio=()=>{setStudioAuth(true);setScreen("editor");};
  const athleteSignOut=()=>{
    if(!isEditorMode)setMyPlayerId(null); /* Clear stored identity on sign-out */
    goToLanding();
  };
  const refreshPlayers=async()=>{try{const cp=await loadPlayersFromCloud();if(cp.length>0){const hp=await hydratePlayerVideos(cp);setPlayers(hp);}}catch(e){console.warn("Refresh failed:",e);}};

  /* Loading screen */
  if(cloudLoading)return(
    <div style={{width:"100vw",height:"100vh",background:C.base,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",fontFamily:"'Inter',sans-serif"}}>
      <h1 style={{fontSize:48,fontWeight:900,fontStyle:"italic",marginBottom:8}}>
        <span style={{color:"#fff"}}>ATHLETES</span><span style={{color:C.coral}}>USA</span>
      </h1>
      <div style={{display:"flex",gap:4,marginTop:16}}>
        {[0,1,2].map(i=><div key={i} style={{width:8,height:8,borderRadius:"50%",background:C.blue,animation:`pulse 1.4s ease-in-out ${i*0.2}s infinite`}}/>)}
      </div>
      <div style={{color:C.sub,fontSize:12,marginTop:12}}>Connecting to cloud...</div>
    </div>);

  /* ── INNER SCREENS (athlete flow + editor) ── */
  if(screen==="editor")return<StudioApp players={players} onLogout={goToLanding} onRefreshPlayers={refreshPlayers}/>;
  if(screen==="athlete"){
    if(athleteStep==="select")return<AthleteSelect players={players} isEditorMode={isEditorMode}
      onSelect={id=>{if(!isEditorMode)setMyPlayerId(id);setActivePlayerId(id);setAthleteStep("portal");}}
      onCreate={()=>setAthleteStep("form")} onBack={goToLanding} onDelete={handleDeletePlayer}/>;
    if(athleteStep==="form")return<AthleteProfileForm onSubmit={handleCreateProfile} onBack={()=>setAthleteStep("select")}/>;
    if(athleteStep==="portal"&&activePlayer)return<AthletePortal player={activePlayer} onUpdatePlayer={handleUpdatePlayer}
      isEditorMode={isEditorMode} onBack={isEditorMode?()=>{setAthleteStep("select");setActivePlayerId(null);}:athleteSignOut}/>;
  }

  /* ── LANDING SCREENS (based on hash route) ── */

  /* #/athlete → Athlete-only entry (NO studio access) */
  if(route==="athlete"){
    return<AthleteLandingPage onEnter={enterAthlete}/>;
  }

  /* #/studio → Studio entry (password-gated, editors CAN also view athlete pages) */
  if(route==="studio"){
    return<StudioLandingPage
      onEnterStudio={enterStudio}
      onEnterAthleteReview={()=>{setStudioAuth(true);enterAthleteAsEditor();}}/>;
  }

  /* Default (no hash or #/) → combined landing with both tiles (backward compat) */
  return<LandingPage onEnterAthlete={enterAthlete} onEnterStudio={enterStudio}/>;
}

ReactDOM.render(<App/>,document.getElementById("root"));
</script>
</body>
</html>
